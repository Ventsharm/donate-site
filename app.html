<!doctype html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Donate App – Dashboard</title><meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/><meta http-equiv="Pragma" content="no-cache"/><meta http-equiv="Expires" content="0"/><style>html,body{height:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f3f6ff;display:flex;align-items:center;justify-content:center;padding:24px}*{box-sizing:border-box}.card{width:min(740px,100%);background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:24px;box-shadow:0 16px 55px rgba(0,0,0,.10);padding:22px}.topRow{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}.h1{font-size:44px;line-height:1;margin:0 0 8px;font-weight:900;letter-spacing:-1px;color:#0b1320}.sub{margin:0 0 10px;color:#3d4a63;font-weight:650}.rightActions{display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap}.linkBtn{background:transparent;border:0;color:#1b4dd8;font-weight:900;font-size:18px;cursor:pointer;padding:8px 0}.smallBtn{background:#eef1f6;border:0;border-radius:14px;padding:10px 12px;font-weight:900;cursor:pointer;color:#0b1320}.msg{display:none;margin:12px 0 16px;padding:12px 14px;border-radius:14px;border:1px solid rgba(0,0,0,.08);background:#f6f8ff;color:#1e2a44;font-weight:800;white-space:pre-wrap}.msg[data-type="ok"]{background:#eafff1;color:#0f6b2f}.msg[data-type="warn"]{background:#ffecec;color:#a01414}.msg[data-type="err"]{background:#ffecec;color:#a01414}.row{display:grid;gap:10px;margin:12px 0}label{font-weight:900;color:#1e2a44}.in{width:100%;padding:14px 14px;border-radius:14px;border:1px solid rgba(0,0,0,.14);background:#f1f6ff;font-size:16px;outline:none}.ta{min-height:180px;resize:vertical;line-height:1.45}.btn{padding:15px 16px;border-radius:16px;border:0;font-size:18px;font-weight:900;cursor:pointer}.btnPrimary{background:#0b0b0d;color:#fff;box-shadow:0 10px 25px rgba(0,0,0,.18)}.btnGhost{background:#eef1f6;color:#0b1320}.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}.panel{margin-top:14px;border-radius:18px;border:1px solid rgba(0,0,0,.10);padding:16px;background:#fff}.pill{padding:12px 14px;border-radius:14px;border:1px solid rgba(0,0,0,.08);background:#f6f8ff;color:#1e2a44;font-weight:900}.goodPill{background:#eafff1;color:#0f6b2f}.footerMini{margin-top:12px;color:#5d6b86;font-size:13px;font-weight:650;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:13px}</style></head><body><div class="card"><div class="topRow"><div><h1 class="h1">Your donation page</h1><p class="sub">Write your story + paste your Stripe Payment Link. Then share your page.</p></div><div class="rightActions"><button id="toLoginBtn" class="smallBtn" type="button">Back to login</button><button id="logoutBtn" class="linkBtn" type="button">Logout</button></div></div><div id="statusBox" class="msg"></div><div id="main" style="display:none"><div class="panel"><div class="row"><label for="title">Headline (optional)</label><input id="title" class="in" type="text" placeholder="e.g. Help me get back on my feet"/></div><div class="row"><label for="about">Why do you need donations?</label><textarea id="about" class="in ta" placeholder="Explain your situation, what the money is for, and any proof/updates you want to share…"></textarea></div><div class="row"><label for="paylink">Your Stripe Payment Link (required)</label><input id="paylink" class="in" type="url" placeholder="https://buy.stripe.com/xxxxx (create this in your Stripe dashboard)"/></div><div class="grid2"><button id="saveBtn" class="btn btnPrimary" type="button">Save</button><button id="openBtn" class="btn btnGhost" type="button">Open my public page</button></div></div><div class="panel"><div class="pill"><div style="font-size:14px;color:#52607a;font-weight:800;margin-bottom:8px">Share this link</div><div id="shareLink" class="mono"></div><div style="height:10px"></div><button id="copyBtn" class="btn btnGhost" type="button" style="width:100%">Copy link</button></div></div></div><div class="footerMini"><span id="whoami"></span><span id="buildTag"></span></div></div><script>(function(){if(window.__donateAppBooted)return;window.__donateAppBooted=1;var sb=document.getElementById("statusBox");function setMsg(t,type){if(!sb)return;sb.textContent=t||"";sb.style.display=t?"block":"none";sb.dataset.type=type||"info"}window.addEventListener("error",function(e){setMsg("JS ERROR:\n"+(e.message||e.error||e),"err")});window.addEventListener("unhandledrejection",function(e){var r=e&&e.reason;setMsg("PROMISE ERROR:\n"+((r&&r.message)?r.message:String(r)),"err")});})();</script><script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import{getAuth,onAuthStateChanged,signOut,setPersistence,browserLocalPersistence}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import{getFirestore,doc,getDoc,setDoc}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyBMZo5HOStyDEINl2xLm-M9X4PaDc-raBQ",authDomain:"donate-app-ff07c.firebaseapp.com",projectId:"donate-app-ff07c",storageBucket:"donate-app-ff07c.firebasestorage.app",messagingSenderId:"950201336557",appId:"1:950201336557:web:e8bdfa02d99512051f82e4"};
const app=initializeApp(firebaseConfig),auth=getAuth(app),db=getFirestore(app);
try{setPersistence(auth,browserLocalPersistence)}catch(_){}

const el=(id)=>document.getElementById(id);
const statusBox=el("statusBox"),main=el("main"),whoami=el("whoami"),buildTag=el("buildTag");
const titleEl=el("title"),aboutEl=el("about"),paylinkEl=el("paylink");
const saveBtn=el("saveBtn"),openBtn=el("openBtn"),copyBtn=el("copyBtn"),shareLink=el("shareLink");
const logoutBtn=el("logoutBtn"),toLoginBtn=el("toLoginBtn");

buildTag.textContent="build: "+new Date().toISOString().slice(0,16).replace("T"," ");
const setMsg=(t,type="info")=>{statusBox.textContent=t||"";statusBox.style.display=t?"block":"none";statusBox.dataset.type=type;};
const disable=(b,y)=>{if(!b)return;b.disabled=!!y;b.style.opacity=y?".7":"1";b.style.cursor=y?"not-allowed":"pointer"};

const campaignRef=(uid)=>doc(db,"campaigns",uid); // public doc
const accessRef=(uid)=>doc(db,"users",uid,"access","status"); // paid gate

function makeShare(uid){const base=location.origin+location.pathname.replace(/[^\/]*$/,"");return base+"donate.html?u="+encodeURIComponent(uid);}
function cleanUrl(u){try{return new URL(String(u||"")).toString()}catch(_){return ""}}

toLoginBtn.onclick=()=>location.href="./";
logoutBtn.onclick=async()=>{try{await signOut(auth)}catch(_){ }location.href="./";};

copyBtn.onclick=async()=>{try{await navigator.clipboard.writeText(shareLink.textContent||"");setMsg("Copied ✅","ok")}catch(e){setMsg("Copy failed. Hold the link and copy manually.","warn")}};

openBtn.onclick=()=>{const u=auth.currentUser;if(!u)return;location.href=makeShare(u.uid);};

saveBtn.onclick=async()=>{try{
  const u=auth.currentUser;if(!u){setMsg("You are not logged in.","err");return;}
  const title=(titleEl.value||"").trim().slice(0,120);
  const about=(aboutEl.value||"").trim().slice(0,5000);
  const paylink=cleanUrl(paylinkEl.value);
  if(!paylink||!paylink.startsWith("https://")){setMsg("Paste a valid Stripe Payment Link (must start with https://).","warn");return;}
  disable(saveBtn,true);disable(openBtn,true);setMsg("Saving…","info");
  await setDoc(campaignRef(u.uid),{uid:u.uid,title,about,paylink,updatedAt:Date.now()},{merge:true});
  setMsg("Saved ✅ Your public page is ready.","ok");
}catch(e){setMsg("Save failed:\n"+(e.message||e),"err");}finally{disable(saveBtn,false);disable(openBtn,false);}
};

onAuthStateChanged(auth,async(u)=>{try{
  main.style.display="none";whoami.textContent="";
  if(!u){setMsg("Not logged in. Go back to login.","warn");return;}
  whoami.textContent=u.email||"";
  setMsg("Checking access…","info");

  const a=await getDoc(accessRef(u.uid));
  const paid=!!(a.exists()&&a.data()?.paid===true);
  if(!paid){setMsg("You haven’t unlocked the app yet. Go back and pay £5 first.","warn");return;}

  const link=makeShare(u.uid);
  shareLink.textContent=link;

  const snap=await getDoc(campaignRef(u.uid));
  if(snap.exists()){
    const d=snap.data()||{};
    titleEl.value=d.title||"";
    aboutEl.value=d.about||"";
    paylinkEl.value=d.paylink||"";
    setMsg("Loaded your saved page ✅","ok");
  }else{
    setMsg("Fill this in, save, then share your link.","ok");
  }

  main.style.display="block";
}catch(e){setMsg("Error:\n"+(e.message||e),"err");}});
</script></body></html>
