<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Your Account</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:sans-serif;max-width:720px;margin:0 auto;padding:24px}
    h1{margin-bottom:10px}
    #card{margin-top:14px;padding:16px;border:1px solid rgba(0,0,0,.12);border-radius:14px}
    button{padding:14px 16px;border-radius:12px;border:0;cursor:pointer;font-size:16px}
    .primary{background:#111;color:#fff;width:100%}
    .muted{background:#eee}
    small{opacity:.7}
  </style>
</head>
<body>

<h1>Your account</h1>
<div id="card">Checking accessâ€¦</div>
<div style="height:12px"></div>
<button id="logout" class="muted">Logout</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/* ðŸ”´ PASTE YOUR FIREBASE CONFIG HERE ðŸ”´ */
const firebaseConfig = {
  apiKey: "PASTE_API_KEY",
  authDomain: "PASTE_AUTH_DOMAIN",
  projectId: "PASTE_PROJECT_ID",
  storageBucket: "PASTE_STORAGE_BUCKET",
  messagingSenderId: "PASTE_SENDER_ID",
  appId: "PASTE_APP_ID"
};
/* ðŸ”´ END CONFIG ðŸ”´ */

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const card = document.getElementById("card");
const logoutBtn = document.getElementById("logout");

logoutBtn.onclick = async () => {
  await signOut(auth);
  location.href = "login.html";
};

onAuthStateChanged(auth, async (u) => {
  if (!u) {
    location.href = "login.html";
    return;
  }

  try {
    const snap = await getDoc(doc(db, "users", u.uid));
    const data = snap.exists() ? snap.data() : {};
    const unlocked = !!data.unlocked;

    if (unlocked) {
      card.innerHTML = `
        âœ… <strong>Unlocked</strong><br>
        <small>${u.email || ""}</small><br><br>
        You have full access.
      `;
    } else {
      card.innerHTML = `
        ðŸ”’ <strong>Locked</strong><br>
        <small>${u.email || ""}</small><br><br>
        <button id="go" class="primary">Pay Â£5 to unlock</button>
      `;

      document.getElementById("go").onclick = async () => {
        try {
          const token = await u.getIdToken();
          const res = await fetch(
            "https://createcheckout-ywfufoyxmq-nw.a.run.app",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
              },
              body: "{}"
            }
          );

          const data = await res.json();
          if (!res.ok || !data.url) {
            alert(data.error || "Checkout error");
          } else {
            location.href = data.url;
          }
        } catch (e) {
          alert("Error: " + (e.message || e));
        }
      };
    }
  } catch (e) {
    card.textContent = "Error: " + (e.message || e);
  }
});
</script>

</body>
</html>
