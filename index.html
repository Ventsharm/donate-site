<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Donate</title>

<style>
:root{
--bg:#f3f6ff;--card:#fff;--text:#0b1320;--muted:#52607a;
--pill:#eef2ff;--btn:#0b0b0d;--green:#19c37d;--danger:#fee2e2
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
.wrap{min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
.card{width:100%;max-width:560px;background:#fff;border-radius:22px;
box-shadow:0 20px 60px rgba(0,0,0,.12);padding:22px}

h1{margin:0;font-size:46px;font-weight:900}
.sub{color:#475569;font-weight:600;margin:6px 0 16px}

.row{margin:12px 0}
label{font-weight:800}
input,textarea{
width:100%;padding:14px;border-radius:14px;border:1px solid #c7d2fe;
background:var(--pill);font-size:16px
}
textarea{min-height:120px}

button{
width:100%;padding:15px;border-radius:16px;border:none;
font-weight:900;font-size:17px;cursor:pointer
}
.primary{background:var(--btn);color:#fff}
.green{background:var(--green);color:#042f1a}
.ghost{background:#eef2ff}
.danger{background:var(--danger);color:#991b1b}

.msg{display:none;margin:14px 0;padding:12px;border-radius:14px;font-weight:800}
.msg.ok{background:#ecfdf5;color:#065f46}
.msg.err{background:#fee2e2;color:#991b1b}
.msg.warn{background:#fff7ed;color:#9a3412}

hr{border:none;height:1px;background:#e5e7eb;margin:18px 0}

#login,#editor,#public,#verify{display:none}
.link{background:#f1f5f9;padding:12px;border-radius:12px;word-break:break-all}
.small{font-size:13px;color:#64748b}

.topActions{display:flex;gap:10px;justify-content:flex-end}
.linkBtn{background:none;border:none;color:#2563eb;font-weight:800;cursor:pointer}
</style>
</head>

<body>
<div class="wrap">
<div class="card">

<div class="topActions">
<button id="logoutBtn" class="linkBtn" style="display:none">Logout</button>
</div>

<h1 id="title">Sign in</h1>
<p id="subtitle" class="sub">Create or manage your donation page.</p>

<div id="msg" class="msg"></div>

<!-- LOGIN -->
<div id="login">
<div class="row"><label>Email</label><input id="email"></div>
<div class="row"><label>Password</label><input id="pass" type="password"></div>
<button id="loginBtn" class="primary">Login</button>
<div style="height:10px"></div>
<button id="signupBtn" class="ghost">Create account</button>
<button id="forgotBtn" class="ghost" style="margin-top:8px">Forgot password</button>
</div>

<!-- VERIFY -->
<div id="verify">
<p class="sub">Check your email and verify your account.</p>
<button id="resendBtn" class="ghost">Resend email</button>
<button id="verifiedBtn" class="primary" style="margin-top:10px">Iâ€™ve verified</button>
</div>

<!-- EDITOR -->
<div id="editor">
<button id="connectBtn" class="primary">Connect Stripe</button>

<hr>

<div class="row"><label>Campaign title</label><input id="campTitle"></div>
<div class="row"><label>About</label><textarea id="campAbout"></textarea></div>

<button id="saveBtn" class="primary">Save campaign</button>
<button id="copyBtn" class="ghost" style="margin-top:8px">Copy public link</button>
<div id="linkBox" class="link" style="display:none"></div>

<button id="deleteAccountBtn" class="danger" style="margin-top:14px">Delete account</button>
</div>

<!-- PUBLIC -->
<div id="public">
<h1 id="pTitle"></h1>
<p class="sub" id="pAbout"></p>
<button id="donateBtn" class="green">Donate</button>
<button onclick="location.href='./'" class="ghost" style="margin-top:10px">Back</button>
</div>

</div>
</div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import{getAuth,onAuthStateChanged,signInWithEmailAndPassword,
createUserWithEmailAndPassword,sendPasswordResetEmail,
sendEmailVerification,signOut,deleteUser}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import{getFirestore,doc,getDoc,setDoc,deleteDoc}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyBMZo5HOStyDEINl2xLm-M9X4PaDc-raBQ",
authDomain:"donate-app-ff07c.firebaseapp.com",
projectId:"donate-app-ff07c"
};

const CONNECT_URL="https://europe-west2-donate-app-ff07c.cloudfunctions.net/createConnectLink";
const DONATE_URL="https://europe-west2-donate-app-ff07c.cloudfunctions.net/createDonationCheckout";

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

const qs=new URLSearchParams(location.search);
const campaignId=qs.get("c");

const el=id=>document.getElementById(id);
const msg=(t,type)=>{const m=el("msg");m.textContent=t;m.className="msg "+type;m.style.display="block"};

const show=id=>{
["login","editor","public","verify"].forEach(v=>el(v).style.display="none");
el(id).style.display="block";
};

if(campaignId){
show("public");
const snap=await getDoc(doc(db,"campaigns",campaignId));
if(!snap.exists())msg("Campaign not found","err");
else{
const d=snap.data();
el("pTitle").textContent=d.title;
el("pAbout").textContent=d.about;
el("donateBtn").onclick=async()=>{
const res=await fetch(DONATE_URL,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({campaignUid:campaignId,amount:500})
});
const j=await res.json();
location.href=j.url;
};
}
}else{
show("login");
}

onAuthStateChanged(auth,async user=>{
if(!user)return;
if(!user.emailVerified){show("verify");return;}
show("editor");
el("logoutBtn").style.display="inline-block";
const ref=doc(db,"campaigns",user.uid);
const snap=await getDoc(ref);
if(snap.exists()){
el("campTitle").value=snap.data().title||"";
el("campAbout").value=snap.data().about||"";
}
});

el("loginBtn").onclick=async()=>{
try{await signInWithEmailAndPassword(auth,email.value,pass.value)}
catch(e){msg(e.message,"err")}
};

el("signupBtn").onclick=async()=>{
try{
const c=await createUserWithEmailAndPassword(auth,email.value,pass.value);
await sendEmailVerification(c.user);
msg("Check your email to verify","ok");
}catch(e){msg(e.message,"err")}
};

el("forgotBtn").onclick=()=>sendPasswordResetEmail(auth,email.value).then(()=>msg("Email sent","ok"));

el("verifiedBtn").onclick=()=>location.reload();

el("saveBtn").onclick=async()=>{
const u=auth.currentUser;
await setDoc(doc(db,"campaigns",u.uid),{
title:campTitle.value,about:campAbout.value
},{merge:true});
msg("Saved","ok");
};

el("copyBtn").onclick=()=>{
const u=auth.currentUser;
const url=location.origin+location.pathname+"?c="+u.uid;
navigator.clipboard.writeText(url);
el("linkBox").textContent=url;
el("linkBox").style.display="block";
};

el("connectBtn").onclick=async()=>{
const u=auth.currentUser;
const t=await u.getIdToken();
const r=await fetch(CONNECT_URL,{
method:"POST",
headers:{
"Authorization":"Bearer "+t,
"Content-Type":"application/json"
},
body:JSON.stringify({returnUrl:location.href})
});
const j=await r.json();
location.href=j.url;
};

el("deleteAccountBtn").onclick=async()=>{
if(!confirm("Delete account permanently?"))return;
const u=auth.currentUser;
await deleteDoc(doc(db,"campaigns",u.uid));
await deleteUser(u);
location.href="./";
};

el("logoutBtn").onclick=()=>signOut(auth);
</script>
</body>
</html>
