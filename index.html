const { onRequest } = require("firebase-functions/v2/https");
const { setGlobalOptions } = require("firebase-functions/v2");
const logger = require("firebase-functions/logger");
const cors = require("cors")({ origin: true });

setGlobalOptions({ region: "europe-west2" });

const functions = require("firebase-functions");
const stripeSecret = functions.config().stripe && functions.config().stripe.secret;
if (!stripeSecret) {
  logger.warn("Stripe secret missing. Run: firebase functions:config:set stripe.secret=\"sk_test_...\"");
}
const Stripe = require("stripe");
const stripe = stripeSecret ? new Stripe(stripeSecret) : null;

exports.createCheckout = onRequest(async (req, res) => {
  return cors(req, res, async () => {
    try {
      if (req.method !== "POST") return res.status(405).json({ error: "Use POST" });
      if (!stripe) return res.status(500).json({ error: "Stripe secret not set on server." });

      const { amount, currency } = req.body || {};
      const amt = Number(amount);
      if (!amt || amt < 50) return res.status(400).json({ error: "Invalid amount" });

      const origin = req.headers.origin || "https://ventsharm.github.io";
      const session = await stripe.checkout.sessions.create({
        mode: "payment",
        payment_method_types: ["card"],
        line_items: [{
          price_data: {
            currency: (currency || "gbp").toLowerCase(),
            product_data: { name: "Donation" },
            unit_amount: amt
          },
          quantity: 1
        }],
        success_url: `${origin}/?success=1`,
        cancel_url: `${origin}/?canceled=1`
      });

      return res.json({ url: session.url });
    } catch (e) {
      logger.error(e);
      return res.status(500).json({ error: e.message || "Server error" });
    }
  });
});

