<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Donate App – Login</title>

<style>
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f3f6ff;display:flex;align-items:center;justify-content:center;padding:24px}
*{box-sizing:border-box}
.card{width:min(560px,100%);background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:24px;box-shadow:0 16px 55px rgba(0,0,0,.10);padding:22px}
.h1{font-size:54px;line-height:1;margin:0 0 10px;font-weight:900;letter-spacing:-1px;color:#0b1320}
.sub{margin:0 0 12px;color:#3d4a63;font-weight:600}
.msg{display:none;margin:12px 0 16px;padding:12px 14px;border-radius:14px;border:1px solid rgba(0,0,0,.08);background:#f6f8ff;font-weight:700}
.msg[data-type="ok"]{background:#eafff1;color:#0f6b2f}
.msg[data-type="warn"]{background:#ffecec;color:#a01414}
.msg[data-type="err"]{background:#ffecec;color:#a01414}
.row{display:grid;gap:10px;margin:12px 0}
label{font-weight:900;color:#1e2a44}
.in{width:100%;padding:14px;border-radius:14px;border:1px solid rgba(0,0,0,.14);background:#f1f6ff;font-size:16px}
.btn{width:100%;padding:15px;border-radius:16px;border:0;font-size:18px;font-weight:900;cursor:pointer}
.btnPrimary{background:#0b0b0d;color:#fff}
.btnGhost{background:#eef1f6}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.payCard{margin-top:16px;border-radius:18px;border:1px solid rgba(0,0,0,.10);padding:16px}
.good{background:#eafff1;color:#0f6b2f;padding:12px;border-radius:14px;font-weight:900}
.skel{background:#f6f8ff;padding:12px;border-radius:14px;font-weight:900}
#auth,#pay,#app{display:none}
</style>
</head>

<body>
<div class="card">
<h1 class="h1">Sign in</h1>
<p class="sub">Login first, then pay once to unlock the app.</p>

<div id="msg" class="msg"></div>
<div id="boot" class="skel">Loading…</div>

<div id="auth">
<div class="row"><label>Email</label><input id="email" class="in" type="email"></div>
<div class="row"><label>Password</label><input id="pass" class="in" type="password"></div>
<button id="login" class="btn btnPrimary">Login</button>
<div style="height:10px"></div>
<div class="grid2">
<button id="create" class="btn btnGhost">Create account</button>
<button id="forgot" class="btn btnGhost">Forgot password</button>
</div>
</div>

<div id="pay" class="payCard">
<p><strong>Payment required.</strong></p>
<button id="payBtn" class="btn btnPrimary">Pay £5</button>
</div>

<div id="app">
<div class="good">Access granted ✅</div>
</div>
</div>

<script type="module">
if(window.__booted)return;window.__booted=1;

import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import{getAuth,onAuthStateChanged,signInWithEmailAndPassword,createUserWithEmailAndPassword,sendPasswordResetEmail}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import{getFirestore,doc,getDoc}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyBMZo5HOStyDEINl2xLm-M9X4PaDc-raBQ",
 authDomain:"donate-app-ff07c.firebaseapp.com",
 projectId:"donate-app-ff07c",
 storageBucket:"donate-app-ff07c.firebasestorage.app",
 messagingSenderId:"950201336557",
 appId:"1:950201336557:web:e8bdfa02d99512051f82e4"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

const CREATE_CHECKOUT_URL="https://createcheckout-ywfufoyxmq-nw.a.run.app";
const ACCESS_DOC=(uid)=>doc(db,"users",uid,"access","status");

const el=id=>document.getElementById(id);
const msg=el("msg"),boot=el("boot"),authW=el("auth"),payW=el("pay"),appW=el("app");
const email=el("email"),pass=el("pass");

const show=(e,b)=>e.style.display=b?"block":"none";
const setMsg=(t,type)=>{msg.textContent=t;msg.dataset.type=type;msg.style.display="block"};

onAuthStateChanged(auth,async u=>{
 show(boot,false);
 if(!u){show(authW,true);show(payW,true);return;}
 const snap=await getDoc(ACCESS_DOC(u.uid));
 if(snap.exists()&&snap.data().paid){
   show(appW,true);
 }else{
   show(authW,true);show(payW,true);
 }
});

el("login").onclick=()=>signInWithEmailAndPassword(auth,email.value,pass.value).catch(e=>setMsg(e.message,"err"));
el("create").onclick=()=>createUserWithEmailAndPassword(auth,email.value,pass.value).catch(e=>setMsg(e.message,"err"));
el("forgot").onclick=()=>sendPasswordResetEmail(auth,email.value).then(()=>setMsg("Email sent","ok")).catch(e=>setMsg(e.message,"err"));

el("payBtn").onclick=async()=>{
 const u=auth.currentUser;if(!u)return setMsg("Login first","warn");
 const idToken=await u.getIdToken(true);
 const base=location.origin+location.pathname.replace(/[^\/]*$/,"");
 const res=await fetch(CREATE_CHECKOUT_URL,{
   method:"POST",
   headers:{"Content-Type":"application/json"},
   body:JSON.stringify({idToken,successUrl:base+"?success=1",cancelUrl:base})
 });
 const data=await res.json();
 location.href=data.url;
};
</script>
</body>
</html>
