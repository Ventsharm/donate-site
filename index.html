<!doctype html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Donate App</title><meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/><meta http-equiv="Pragma" content="no-cache"/><meta http-equiv="Expires" content="0"/><style>*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f3f6ff;padding:18px;display:flex;align-items:flex-start;justify-content:center} .wrap{width:min(620px,100%)} .card{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:24px;box-shadow:0 16px 55px rgba(0,0,0,.10);padding:20px;margin:0 auto} .h1{font-size:54px;line-height:1;margin:0 0 10px;font-weight:900;letter-spacing:-1px;color:#0b1320} .sub{margin:0 0 14px;color:#3d4a63;font-weight:650} .msg{display:none;margin:12px 0 16px;padding:12px 14px;border-radius:14px;border:1px solid rgba(0,0,0,.08);background:#f6f8ff;color:#1e2a44;font-weight:800;white-space:pre-wrap} .msg[data-type="ok"]{background:#eafff1;color:#0f6b2f} .msg[data-type="warn"]{background:#ffecec;color:#a01414} .msg[data-type="err"]{background:#ffecec;color:#a01414} .row{display:grid;gap:10px;margin:12px 0} label{font-weight:900;color:#1e2a44} .in{width:100%;padding:14px 14px;border-radius:14px;border:1px solid rgba(0,0,0,.14);background:#f1f6ff;font-size:16px;outline:none} textarea.in{min-height:140px;resize:vertical} .btn{width:100%;padding:15px 16px;border-radius:16px;border:0;font-size:18px;font-weight:900;cursor:pointer} .btnPrimary{background:#0b0b0d;color:#fff;box-shadow:0 10px 25px rgba(0,0,0,.18)} .btnGhost{background:#eef1f6;color:#0b1320} .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px} .topRow{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap} .rightActions{display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap} .linkBtn{background:transparent;border:0;color:#1b4dd8;font-weight:900;font-size:18px;cursor:pointer;padding:8px 0} .smallBtn{background:#eef1f6;border:0;border-radius:14px;padding:10px 12px;font-weight:900;cursor:pointer;color:#0b1320} .payCard{margin-top:16px;border-radius:18px;border:1px solid rgba(0,0,0,.10);padding:16px;background:#fff} .payTitle{font-size:22px;margin:0 0 6px;font-weight:900} .payText{margin:0 0 12px;color:#52607a;font-weight:650} .payBtn{background:#19c37d;color:#062a19;box-shadow:0 12px 30px rgba(25,195,125,.25)} .tiny{margin-top:10px;color:#5d6b86;font-size:13px;line-height:1.35} .appTitle{margin:0 0 10px;font-size:44px;letter-spacing:-1px} .pillOk{padding:12px 14px;border-radius:14px;border:1px solid rgba(0,0,0,.08);background:#eafff1;color:#0f6b2f;font-weight:900} .pillInfo{padding:12px 14px;border-radius:14px;border:1px solid rgba(0,0,0,.08);background:#f6f8ff;color:#1e2a44;font-weight:900} .muted{margin:10px 0 0;color:#52607a;font-weight:650} .footerMini{margin-top:12px;color:#5d6b86;font-size:13px;font-weight:650;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap} .publicCard{margin-top:16px} .publicTitle{font-size:42px;font-weight:900;letter-spacing:-1px;margin:0 0 10px;color:#0b1320} .publicAbout{white-space:pre-wrap;color:#26324a;font-weight:650;line-height:1.45} .donateA{display:block;text-decoration:none;text-align:center} .hidden{display:none!important}</style></head><body><div class="wrap"><div id="privateCard" class="card"><div class="topRow"><div><h1 id="hdrTitle" class="h1">Sign in</h1><p id="hdrSub" class="sub">Login first, then pay once to unlock the app.</p></div><div class="rightActions"><button id="switchUserBtn" class="smallBtn" type="button" style="display:none">Use different account</button><button id="logoutBtn" class="linkBtn" type="button" style="display:none">Logout</button></div></div><div id="statusBox" class="msg"></div><div id="bootCover" class="pillInfo">Loading…</div><div id="authWrap" class="hidden"><div class="row"><label for="email">Email</label><input id="email" class="in" type="email" autocomplete="email" placeholder="you@email.com"/></div><div class="row"><label for="password">Password</label><input id="password" class="in" type="password" autocomplete="current-password" placeholder="••••••••"/></div><button id="loginBtn" class="btn btnPrimary" type="button">Login</button><div style="height:12px"></div><div class="grid2"><button id="createBtn" class="btn btnGhost" type="button">Create account</button><button id="forgotBtn" class="btn btnGhost" type="button">Forgot password</button></div></div><div id="verifyWrap" class="hidden"><div class="pillInfo">Please verify your email to continue.<br/>We’ve sent a verification email (check inbox/spam).</div><div style="height:12px"></div><div class="grid2"><button id="resendBtn" class="btn btnGhost" type="button">Resend email</button><button id="logoutBtn2" class="btn btnPrimary" type="button">Logout</button></div></div><div id="payWrap" class="payCard hidden"><div class="payTitle">Payment required</div><p class="payText">Pay once to unlock the app.</p><button id="payBtn" class="btn payBtn" type="button">Pay £5</button><div class="tiny">After payment you’ll be redirected back here. If it still says unpaid, tap Logout then login again.</div></div><div id="appWrap" class="hidden" style="margin-top:16px"><h2 class="appTitle">Your campaign</h2><div class="pillOk">Access granted ✅</div><p class="muted">Fill in your campaign text and your Stripe Payment Link. Then share your public page.</p><hr style="border:0;border-top:1px solid rgba(0,0,0,.08);margin:14px 0"/><div class="row"><label for="campTitle">Campaign title</label><input id="campTitle" class="in" type="text" placeholder="e.g. Help me with rent"/></div><div class="row"><label for="campAbout">About (why you need donations)</label><textarea id="campAbout" class="in" placeholder="Explain your situation…"></textarea></div><div class="row"><label for="campStripe">Your Stripe Payment Link URL</label><input id="campStripe" class="in" type="url" placeholder="https://buy.stripe.com/..."/></div><div class="grid2"><button id="saveBtn" class="btn btnPrimary" type="button">Save campaign</button><button id="copyBtn" class="btn btnGhost" type="button">Copy public link</button></div><div id="publicLinkBox" class="pillInfo" style="margin-top:12px;word-break:break-word" class="hidden"></div><div class="tiny" style="margin-top:10px">How to get your Stripe link: Stripe Dashboard → Payment Links → New → create → copy the link URL → paste above.</div></div><div class="footerMini"><span id="whoami"></span><span id="buildTag"></span></div></div><div id="publicCard" class="card publicCard hidden"><div class="publicTitle" id="pTitle">Campaign</div><div class="publicAbout" id="pAbout"></div><a id="pDonate" class="btn payBtn donateA" href="#" target="_blank" rel="noopener">Donate</a><div class="tiny" style="margin-top:12px"><a id="backToHome" href="./" style="color:#1b4dd8;font-weight:900;text-decoration:none">Back to home</a></div></div></div><script>(function(){if(window.__donateBooted)return;window.__donateBooted=1;var sb=document.getElementById("statusBox");function setMsg(t,type){if(!sb)return;sb.textContent=t||"";sb.style.display=t?"block":"none";sb.dataset.type=type||"info"}window.addEventListener("error",function(e){setMsg("JS ERROR:\n"+(e.message||e.error||e),"err")});window.addEventListener("unhandledrejection",function(e){var r=e&&e.reason;setMsg("PROMISE ERROR:\n"+((r&&r.message)?r.message:String(r)),"err")});window.__setMsg=setMsg;})();</script><script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import{getAuth,onAuthStateChanged,signInWithEmailAndPassword,createUserWithEmailAndPassword,sendPasswordResetEmail,signOut,setPersistence,browserLocalPersistence,sendEmailVerification}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import{getFirestore,doc,getDoc,setDoc,serverTimestamp}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/* ✅ YOUR Firebase config */
const firebaseConfig={apiKey:"AIzaSyBMZo5HOStyDEINl2xLm-M9X4PaDc-raBQ",authDomain:"donate-app-ff07c.firebaseapp.com",projectId:"donate-app-ff07c",storageBucket:"donate-app-ff07c.firebasestorage.app",messagingSenderId:"950201336557",appId:"1:950201336557:web:e8bdfa02d99512051f82e4"};

/* ✅ Your Cloud Run createCheckout URL */
const CREATE_CHECKOUT_URL="https://createcheckout-ywfufoyxmq-nw.a.run.app";

const el=(id)=>document.getElementById(id);
const setMsg=(t,type="info")=>window.__setMsg?window.__setMsg(t,type):null;

const privateCard=el("privateCard"),publicCard=el("publicCard");
const hdrTitle=el("hdrTitle"),hdrSub=el("hdrSub");
const statusBox=el("statusBox"),bootCover=el("bootCover"),authWrap=el("authWrap"),verifyWrap=el("verifyWrap"),payWrap=el("payWrap"),appWrap=el("appWrap");
const emailEl=el("email"),passEl=el("password");
const loginBtn=el("loginBtn"),createBtn=el("createBtn"),forgotBtn=el("forgotBtn"),logoutBtn=el("logoutBtn"),logoutBtn2=el("logoutBtn2"),switchUserBtn=el("switchUserBtn"),resendBtn=el("resendBtn");
const payBtn=el("payBtn"),saveBtn=el("saveBtn"),copyBtn=el("copyBtn");
const campTitle=el("campTitle"),campAbout=el("campAbout"),campStripe=el("campStripe"),publicLinkBox=el("publicLinkBox");
const whoami=el("whoami"),buildTag=el("buildTag");

const pTitle=el("pTitle"),pAbout=el("pAbout"),pDonate=el("pDonate"),backToHome=el("backToHome");

buildTag.textContent="build: "+new Date().toISOString().slice(0,16).replace("T"," ");

const show=(node,on)=>{if(!node)return;node.classList.toggle("hidden",!on)};
const disable=(btn,on)=>{if(!btn)return;btn.disabled=!!on;btn.style.opacity=on?".7":"1";btn.style.cursor=on?"not-allowed":"pointer"};
const safeEmail=()=>String(emailEl?.value||"").trim();
const safePass=()=>String(passEl?.value||"");
const basePath=()=>location.origin+location.pathname.replace(/\/index\.html$/,"/"); // nice public link
const qs=new URLSearchParams(location.search);
const campaignId=qs.get("c");

/* PUBLIC MODE */
async function bootPublic(cId){
  show(privateCard,false); show(publicCard,true);
  try{
    const snap=await getDoc(doc(db,"campaigns",cId));
    if(!snap.exists()){pTitle.textContent="Not found";pAbout.textContent="This campaign does not exist.";pDonate.style.display="none";return;}
    const d=snap.data()||{};
    pTitle.textContent=d.title||"Campaign";
    pAbout.textContent=d.about||"";
    const link=String(d.stripe||"").trim();
    if(link && /^https?:\/\//i.test(link)){pDonate.href=link;pDonate.style.display="block"} else {pDonate.style.display="none";}
    backToHome.href="./";
  }catch(e){
    pTitle.textContent="Error";pAbout.textContent=String(e?.message||e);pDonate.style.display="none";
  }
}

/* PRIVATE UI STATES */
function uiBoot(){show(bootCover,true);show(authWrap,false);show(verifyWrap,false);show(payWrap,false);show(appWrap,false);show(logoutBtn,false);show(switchUserBtn,false);hdrTitle.textContent="Sign in";hdrSub.textContent="Login first, then pay once to unlock the app.";whoami.textContent="";setMsg("", "info")}
function uiLoggedOut(){show(bootCover,false);show(authWrap,true);show(verifyWrap,false);show(payWrap,true);show(appWrap,false);show(logoutBtn,false);show(switchUserBtn,false);hdrTitle.textContent="Sign in";hdrSub.textContent="Login first, then pay once to unlock the app.";whoami.textContent="";setMsg("Not logged in.","ok")}
function uiVerify(u){show(bootCover,false);show(authWrap,false);show(verifyWrap,true);show(payWrap,false);show(appWrap,false);show(logoutBtn,true);show(switchUserBtn,true);hdrTitle.textContent="Verify email";hdrSub.textContent="Check your inbox then come back.";whoami.textContent=u?.email||"";setMsg("Email not verified yet.","warn")}
function uiNeedPay(u){show(bootCover,false);show(authWrap,false);show(verifyWrap,false);show(payWrap,true);show(appWrap,false);show(logoutBtn,true);show(switchUserBtn,true);hdrTitle.textContent="Unlock";hdrSub.textContent="Pay once to unlock your campaign editor.";whoami.textContent=u?.email||"";setMsg("Logged in ✅ Now pay to unlock.","info")}
function uiGranted(u){show(bootCover,false);show(authWrap,false);show(verifyWrap,false);show(payWrap,false);show(appWrap,true);show(logoutBtn,true);show(switchUserBtn,true);hdrTitle.textContent="";hdrSub.textContent="";whoami.textContent=u?.email||"";setMsg("", "info")}

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

try{setPersistence(auth,browserLocalPersistence)}catch(_){}

/* AUTH ACTIONS */
loginBtn?.addEventListener("click",async()=>{try{disable(loginBtn,true);disable(createBtn,true);disable(forgotBtn,true);setMsg("Signing in…","info");await signInWithEmailAndPassword(auth,safeEmail(),safePass());}catch(err){setMsg("Login failed. If you’re new, tap Create account.\n\n"+(err?.message||""),"err");}finally{disable(loginBtn,false);disable(createBtn,false);disable(forgotBtn,false);}});
createBtn?.addEventListener("click",async()=>{try{disable(loginBtn,true);disable(createBtn,true);disable(forgotBtn,true);setMsg("Creating account…","info");const cred=await createUserWithEmailAndPassword(auth,safeEmail(),safePass());try{await sendEmailVerification(cred.user);}catch(_){ }setMsg("Account created ✅\nPlease verify your email (check inbox/spam), then log in.","ok");}catch(err){setMsg("Create account failed.\n\n"+(err?.message||""),"err");}finally{disable(loginBtn,false);disable(createBtn,false);disable(forgotBtn,false);}});
forgotBtn?.addEventListener("click",async()=>{try{const em=safeEmail();if(!em){setMsg("Enter your email first.","warn");return;}disable(loginBtn,true);disable(createBtn,true);disable(forgotBtn,true);setMsg("Sending reset email…","info");await sendPasswordResetEmail(auth,em);setMsg("Password reset email sent.","ok");}catch(err){setMsg("Reset failed.\n\n"+(err?.message||""),"err");}finally{disable(loginBtn,false);disable(createBtn,false);disable(forgotBtn,false);}});
async function doLogout(){try{await signOut(auth);}catch(_){ }uiLoggedOut();}
logoutBtn?.addEventListener("click",doLogout);
logoutBtn2?.addEventListener("click",doLogout);
switchUserBtn?.addEventListener("click",async()=>{await doLogout();if(emailEl)emailEl.value="";if(passEl)passEl.value="";setMsg("Ready for a different account.","ok");});
resendBtn?.addEventListener("click",async()=>{try{const u=auth.currentUser;if(!u){setMsg("Not logged in.","warn");return;}await sendEmailVerification(u);setMsg("Verification email resent ✅","ok");}catch(e){setMsg("Could not resend.\n\n"+String(e?.message||e),"err");}});

/* CHECKOUT */
payBtn?.addEventListener("click",async()=>{try{
  const u=auth.currentUser;
  if(!u){setMsg("Please log in first, then pay.","warn");return;}
  if(!u.emailVerified){uiVerify(u);return;}
  disable(payBtn,true);setMsg("Opening checkout…","info");
  const idToken=await u.getIdToken(true);
  const base=basePath();
  const successUrl=base+(base.includes("?")?"&":"?")+"success=1";
  const cancelUrl=base;
  const res=await fetch(CREATE_CHECKOUT_URL,{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+idToken},body:JSON.stringify({idToken,successUrl,cancelUrl})});
  if([301,302,303,307,308].includes(res.status)){const loc=res.headers.get("Location");if(loc){location.href=loc;return;}}
  const raw=await res.text().catch(()=> "");
  if(!res.ok) throw new Error("Checkout error ("+res.status+"):\n"+(raw||"(no response body)"));
  let data; try{data=JSON.parse(raw||"{}")}catch(_){throw new Error("Checkout returned invalid JSON:\n"+raw);}
  const url=data?.url||data?.checkoutUrl||data?.checkout_url||data?.sessionUrl||data?.redirectUrl||null;
  if(!url) throw new Error("No checkout URL returned.\nResponse:\n"+JSON.stringify(data,null,2));
  location.href=url;
}catch(e){
  setMsg(String(e?.message||e),"err");
}finally{
  disable(payBtn,false);
}});

/* CAMPAIGN SAVE + LINK */
function publicLink(uid){return basePath()+"?c="+encodeURIComponent(uid);}
copyBtn?.addEventListener("click",async()=>{try{const u=auth.currentUser;if(!u){setMsg("Not logged in.","warn");return;}const link=publicLink(u.uid);await navigator.clipboard.writeText(link);setMsg("Public link copied ✅","ok");}catch(e){setMsg("Copy failed.\n\n"+String(e?.message||e),"err");}});
saveBtn?.addEventListener("click",async()=>{try{
  const u=auth.currentUser;
  if(!u){setMsg("Not logged in.","warn");return;}
  const title=String(campTitle.value||"").trim();
  const about=String(campAbout.value||"").trim();
  const stripe=String(campStripe.value||"").trim();
  if(!title){setMsg("Please enter a campaign title.","warn");return;}
  if(!about){setMsg("Please enter your description.","warn");return;}
  if(!/^https?:\/\//i.test(stripe)){setMsg("Please paste a valid Stripe Payment Link URL (must start with https://).","warn");return;}
  disable(saveBtn,true);setMsg("Saving…","info");
  await setDoc(doc(db,"campaigns",u.uid),{title,about,stripe,updatedAt:serverTimestamp()},{merge:true});
  publicLinkBox.textContent=publicLink(u.uid);
  setMsg("Campaign saved ✅","ok");
}catch(e){
  setMsg("Save failed.\n\n"+String(e?.message||e),"err");
}finally{disable(saveBtn,false);}});

/* ACCESS CHECK */
uiBoot();
if(campaignId){await bootPublic(campaignId);}

/* Auth state */
onAuthStateChanged(auth,async(user)=>{
  if(campaignId) return; // stay public mode
  try{
    if(!user){uiLoggedOut();return;}
    if(qs.has("success")) setMsg("Payment received ✅\nNow we’ll check your access…","ok");
    if(!user.emailVerified){uiVerify(user);return;}
    const accessSnap=await getDoc(doc(db,"users",user.uid,"access","status"));
    const paid=!!(accessSnap.exists() && accessSnap.data()?.paid===true);
    if(!paid){uiNeedPay(user);return;}
    uiGranted(user);
    // load campaign form
    const campSnap=await getDoc(doc(db,"campaigns",user.uid));
    if(campSnap.exists()){
      const d=campSnap.data()||{};
      campTitle.value=d.title||"";
      campAbout.value=d.about||"";
      campStripe.value=d.stripe||"";
    }
    publicLinkBox.textContent=publicLink(user.uid);
  }catch(e){
    const m=String(e?.message||e);
    if(m.toLowerCase().includes("missing or insufficient permissions")){
      setMsg("Permissions error reading Firestore.\n\nRules MUST allow read for:\nusers/{uid}/access/status\nAND allow public read for campaigns/{uid} (public page).","err");
    }else{
      setMsg("Error:\n"+m,"err");
    }
    show(bootCover,false);
    show(authWrap,true);
  }
});
</script></body></html>
