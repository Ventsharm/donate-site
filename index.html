<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Donate</title>

<style>
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f3f6ff;color:#0b1320}
.wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.card{width:min(560px,100%);background:#fff;border-radius:24px;box-shadow:0 16px 55px rgba(0,0,0,.1);padding:22px}
h1{font-size:52px;margin:0 0 10px}
.sub{color:#52607a;font-weight:600;margin-bottom:14px}
.msg{display:none;margin:12px 0;padding:12px 14px;border-radius:14px;font-weight:700}
.msg.ok{background:#eafff1;color:#0f6b2f}
.msg.err{background:#ffecec;color:#a01414}
.btn{width:100%;padding:16px;border-radius:16px;border:0;font-size:18px;font-weight:900;cursor:pointer}
.btnBlack{background:#000;color:#fff}
.btnGreen{background:#19c37d;color:#062a19}
.in{width:100%;padding:14px;border-radius:14px;border:1px solid #ccc;margin-bottom:10px;font-size:16px}
.box{border:1px solid #ddd;border-radius:18px;padding:16px;margin-top:14px}
</style>
</head>

<body>
<div class="wrap">
<div class="card">

<h1 id="title">Sign in</h1>
<p class="sub" id="subtitle">Create or sign in to manage your campaign.</p>

<div id="msg" class="msg"></div>

<div id="login">
<input id="email" class="in" placeholder="Email" type="email">
<input id="password" class="in" placeholder="Password" type="password">
<button class="btn btnBlack" id="loginBtn">Login</button>
</div>

<div id="editor" style="display:none">

<div class="msg ok">Unlocked ✅</div>

<div class="box">
<h2>Stripe Connect</h2>
<p>Connect your Stripe account so donations go directly to you.</p>
<div id="connectStatus" class="msg err">Not connected yet.</div>
<button class="btn btnBlack" id="connectBtn">Connect Stripe</button>
</div>

<div class="box">
<label>Campaign title</label>
<input id="campTitle" class="in">

<label>About</label>
<textarea id="campAbout" class="in"></textarea>

<label>Your Stripe Payment Link</label>
<input id="campStripe" class="in">

<button class="btn btnGreen" id="saveBtn">Save campaign</button>
</div>

</div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMZo5HOStyDEINl2xLm-M9X4PaDc-raBQ",
  authDomain: "donate-app-ff07c.firebaseapp.com",
  projectId: "donate-app-ff07c"
};

const CREATE_CONNECT_URL = "https://europe-west2-donate-app-ff07c.cloudfunctions.net/createConnectLink";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const el = id => document.getElementById(id);
const msg = el("msg");

function showMsg(text,type){
  msg.textContent=text;
  msg.className="msg "+type;
  msg.style.display="block";
}

el("loginBtn").onclick = async () => {
  try{
    await signInWithEmailAndPassword(auth, el("email").value, el("password").value);
  }catch(e){
    showMsg(e.message,"err");
  }
};

onAuthStateChanged(auth, async user => {
  if(!user) return;
  el("login").style.display="none";
  el("editor").style.display="block";
  el("title").textContent="Your campaign";
  el("subtitle").textContent="Edit your campaign and connect Stripe.";

  const snap = await getDoc(doc(db,"campaigns",user.uid));
  if(snap.exists()){
    const d = snap.data();
    el("campTitle").value=d.title||"";
    el("campAbout").value=d.about||"";
    el("campStripe").value=d.stripe||"";
  }
});

el("saveBtn").onclick = async () => {
  const u = auth.currentUser;
  if(!u) return;
  await setDoc(doc(db,"campaigns",u.uid),{
    title: el("campTitle").value,
    about: el("campAbout").value,
    stripe: el("campStripe").value
  });
  showMsg("Saved ✅","ok");
};

el("connectBtn").onclick = async () => {
  const u = auth.currentUser;
  if(!u){
    showMsg("Not logged in.","err");
    return;
  }

  try{
    showMsg("Starting Stripe onboarding…","ok");
    const token = await u.getIdToken(true);

    const res = await fetch(CREATE_CONNECT_URL,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer "+token
      },
      body:"{}"
    });

    const data = await res.json();
    if(!data.url) throw new Error("No URL returned");

    window.location.href = data.url;
  }catch(e){
    showMsg("Connect failed: "+e.message,"err");
  }
};
</script>
</body>
</html>
