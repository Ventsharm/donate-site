<!doctype html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Donate App – Login</title><style>html,body{height:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f3f6ff;display:flex;align-items:center;justify-content:center;padding:24px}*{box-sizing:border-box}.card{width:min(560px,100%);background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:24px;box-shadow:0 16px 55px rgba(0,0,0,.10);padding:22px}.h1{font-size:54px;line-height:1;margin:0 0 10px;font-weight:900;letter-spacing:-1px;color:#0b1320}.sub{margin:0 0 12px;color:#3d4a63;font-weight:600}.msg{display:block;margin:12px 0 16px;padding:12px 14px;border-radius:14px;border:1px solid rgba(0,0,0,.08);background:#f6f8ff;color:#1e2a44;font-weight:800;white-space:pre-wrap}.row{display:grid;gap:10px;margin:12px 0}label{font-weight:900;color:#1e2a44}.in{width:100%;padding:14px;border-radius:14px;border:1px solid rgba(0,0,0,.14);background:#f1f6ff;font-size:16px}.btn{width:100%;padding:15px;border-radius:16px;border:0;font-size:18px;font-weight:900;cursor:pointer}.btnPrimary{background:#0b0b0d;color:#fff}.btnGhost{background:#eef1f6;color:#0b1320}.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}.payCard{margin-top:16px;border-radius:18px;border:1px solid rgba(0,0,0,.10);padding:16px}.good{background:#eafff1;color:#0f6b2f;padding:12px;border-radius:14px;font-weight:900}.hide{display:none!important}</style></head><body><div class="card"><h1 class="h1">Sign in</h1><p class="sub">Login first, then pay once to unlock the app.</p><div id="dbg" class="msg">Booting… (debug build v4)</div><div id="auth" class="hide"><div class="row"><label>Email</label><input id="email" class="in" type="email" autocomplete="email"></div><div class="row"><label>Password</label><input id="pass" class="in" type="password" autocomplete="current-password"></div><button id="login" class="btn btnPrimary" type="button">Login</button><div style="height:10px"></div><div class="grid2"><button id="create" class="btn btnGhost" type="button">Create account</button><button id="forgot" class="btn btnGhost" type="button">Forgot password</button></div></div><div id="pay" class="payCard hide"><p style="margin:0 0 10px"><strong>Payment required.</strong></p><button id="payBtn" class="btn btnPrimary" type="button">Pay £5</button></div><div id="app" class="hide" style="margin-top:16px"><div class="good">Access granted ✅</div></div></div><script>(function(){var d=document.getElementById("dbg");function w(t){d.textContent=t}window.addEventListener("error",function(e){w("JS ERROR:\\n"+(e.message||e.error||e))});window.addEventListener("unhandledrejection",function(e){w("PROMISE ERROR:\\n"+(e.reason&&e.reason.message?e.reason.message:e.reason))})})();</script><script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import{getAuth,onAuthStateChanged,signInWithEmailAndPassword,createUserWithEmailAndPassword,sendPasswordResetEmail}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import{getFirestore,doc,getDoc}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const dbg=document.getElementById("dbg"),authW=document.getElementById("auth"),payW=document.getElementById("pay"),appW=document.getElementById("app");
const show=(el,on)=>el.classList.toggle("hide",!on);
const log=(t)=>{dbg.textContent=t};

log("JS module loaded ✅\\nLoading Firebase…");

const firebaseConfig={apiKey:"AIzaSyBMZo5HOStyDEINl2xLm-M9X4PaDc-raBQ",authDomain:"donate-app-ff07c.firebaseapp.com",projectId:"donate-app-ff07c",storageBucket:"donate-app-ff07c.firebasestorage.app",messagingSenderId:"950201336557",appId:"1:950201336557:web:e8bdfa02d99512051f82e4"};
const CREATE_CHECKOUT_URL="https://createcheckout-ywfufoyxmq-nw.a.run.app";

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);
const ACCESS_DOC=(uid)=>doc(db,"users",uid,"access","status");

const email=document.getElementById("email"),pass=document.getElementById("pass");
document.getElementById("login").onclick=()=>signInWithEmailAndPassword(auth,(email.value||"").trim(),pass.value||"").catch(e=>log("Login failed:\\n"+(e.message||e)));
document.getElementById("create").onclick=()=>createUserWithEmailAndPassword(auth,(email.value||"").trim(),pass.value||"").catch(e=>log("Create failed:\\n"+(e.message||e)));
document.getElementById("forgot").onclick=()=>sendPasswordResetEmail(auth,(email.value||"").trim()).then(()=>log("Reset email sent ✅")).catch(e=>log("Reset failed:\\n"+(e.message||e)));

document.getElementById("payBtn").onclick=async()=>{try{
  const u=auth.currentUser;
  if(!u){log("Please login first.");return;}
  log("Opening checkout…");
  const idToken=await u.getIdToken(true);

  const successUrl=location.origin+location.pathname+"?success=1";
  const cancelUrl=location.origin+location.pathname;

  const res=await fetch(CREATE_CHECKOUT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idToken,successUrl,cancelUrl})});
  const data=await res.json().catch(()=>null);
  if(!data||!data.url)throw new Error("No checkout URL returned");
  location.href=data.url;
}catch(e){log("Checkout error:\\n"+(e.message||e))}};

onAuthStateChanged(auth,async u=>{try{
  show(authW,false);show(payW,false);show(appW,false);
  if(!u){log("Not logged in.");show(authW,true);show(payW,true);return;}
  log("Signed in. Checking access…");
  const snap=await getDoc(ACCESS_DOC(u.uid));
  const paid=!!(snap.exists()&&snap.data()&&snap.data().paid===true);
  if(paid){log("Access granted ✅");show(appW,true);}
  else{log("Logged in, not paid yet.");show(authW,true);show(payW,true);}
}catch(e){log("Access check error:\\n"+(e.message||e));show(authW,true);show(payW,true);}});
</script></body></html>
