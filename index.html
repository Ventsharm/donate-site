<!doctype html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Donate App</title><meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/><meta http-equiv="Pragma" content="no-cache"/><meta http-equiv="Expires" content="0"/><style>html,body{min-height:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f3f6ff;padding:24px;overflow:auto}*{box-sizing:border-box}.wrap{max-width:560px;margin:0 auto}.card{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:24px;box-shadow:0 16px 55px rgba(0,0,0,.10);padding:22px}.h1{font-size:54px;line-height:1;margin:0 0 10px;font-weight:900;letter-spacing:-1px;color:#0b1320}.sub{margin:0 0 14px;color:#3d4a63;font-weight:650}.topRow{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}.rightActions{display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap}.linkBtn{background:transparent;border:0;color:#1b4dd8;font-weight:900;font-size:18px;cursor:pointer;padding:8px 0}.smallBtn{background:#eef1f6;border:0;border-radius:14px;padding:10px 12px;font-weight:900;cursor:pointer;color:#0b1320}.msg{display:none;margin:12px 0 16px;padding:12px 14px;border-radius:14px;border:1px solid rgba(0,0,0,.08);background:#f6f8ff;color:#1e2a44;font-weight:800;white-space:pre-wrap}.msg[data-type="ok"]{background:#eafff1;color:#0f6b2f}.msg[data-type="warn"]{background:#ffecec;color:#a01414}.msg[data-type="err"]{background:#ffecec;color:#a01414}.row{display:grid;gap:10px;margin:12px 0}label{font-weight:900;color:#1e2a44}.in{width:100%;padding:14px;border-radius:14px;border:1px solid rgba(0,0,0,.14);background:#f1f6ff;font-size:16px;outline:none}.ta{min-height:120px;resize:vertical}.btn{width:100%;padding:15px 16px;border-radius:16px;border:0;font-size:18px;font-weight:900;cursor:pointer}.btnPrimary{background:#0b0b0d;color:#fff;box-shadow:0 10px 25px rgba(0,0,0,.18)}.btnGhost{background:#eef1f6;color:#0b1320}.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}.payCard{margin-top:16px;border-radius:18px;border:1px solid rgba(0,0,0,.10);padding:16px;background:#fff}.payTitle{font-size:22px;margin:0 0 6px;font-weight:900}.payText{margin:0 0 12px;color:#52607a;font-weight:650}.payBtn{background:#19c37d;color:#062a19;box-shadow:0 12px 30px rgba(25,195,125,.25)}.tiny{margin-top:10px;color:#5d6b86;font-size:13px;line-height:1.35}.skeleton{padding:12px 14px;border-radius:14px;border:1px solid rgba(0,0,0,.08);background:#f6f8ff;color:#1e2a44;font-weight:900}.title2{margin:16px 0 8px;font-size:46px;letter-spacing:-1px}.goodPill{padding:12px 14px;border-radius:14px;border:1px solid rgba(0,0,0,.08);background:#eafff1;color:#0f6b2f;font-weight:900}.muted{margin:10px 0 0;color:#52607a;font-weight:650}.footerMini{margin-top:12px;color:#5d6b86;font-size:13px;font-weight:650;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}.pubCard{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:24px;box-shadow:0 16px 55px rgba(0,0,0,.10);padding:22px}.pubH{font-size:52px;line-height:1.02;margin:0 0 10px;font-weight:1000;letter-spacing:-1px;color:#0b1320}.donateBtn{display:block;text-align:center;text-decoration:none}.hide{display:none!important}</style></head><body><div class="wrap"><div id="publicWrap" class="pubCard hide"><div class="topRow"><div><h1 class="pubH" id="pubTitle">Campaign</h1><p class="sub" id="pubSub">Loading…</p></div><div class="rightActions"><a id="backHome" class="linkBtn" href="./">Back</a></div></div><div id="pubMsg" class="msg" style="display:block"></div><div style="height:10px"></div><a id="donateLink" class="btn btnPrimary donateBtn" href="#" target="_blank" rel="noopener">Donate</a><div class="tiny" style="margin-top:12px">Payments are processed by Stripe.</div></div><div id="privateWrap" class="card"><div class="topRow"><div><h1 class="h1">Sign in</h1><p class="sub">Login first, then pay once to unlock the app.</p></div><div class="rightActions"><button id="switchUserBtn" class="smallBtn" type="button" style="display:none">Use different account</button><button id="logoutBtn" class="linkBtn" type="button" style="display:none">Logout</button></div></div><div id="statusBox" class="msg"></div><div id="bootCover" class="skeleton">Loading…</div><div id="authWrap" class="hide"><div class="row"><label for="email">Email</label><input id="email" class="in" type="email" autocomplete="email" placeholder="you@email.com"/></div><div class="row"><label for="password">Password</label><input id="password" class="in" type="password" autocomplete="current-password" placeholder="••••••••"/></div><button id="loginBtn" class="btn btnPrimary" type="button">Login</button><div style="height:12px"></div><div class="grid2"><button id="createBtn" class="btn btnGhost" type="button">Create account</button><button id="forgotBtn" class="btn btnGhost" type="button">Forgot password</button></div></div><div id="payWrap" class="payCard hide"><div class="payTitle">Payment required.</div><p class="payText">Pay once to unlock the app.</p><button id="payBtn" class="btn payBtn" type="button">Pay £5</button><div class="tiny">After payment you’ll be redirected back here. If you paid and it still says unpaid, tap “Logout” then login again.</div></div><div id="appWrap" class="hide"><h2 class="title2">Your campaign</h2><div class="goodPill">Access granted ✅</div><p class="sub" style="margin-top:12px">Fill in your campaign text and your Stripe Payment Link. Then share your public page.</p><hr style="border:0;border-top:1px solid rgba(0,0,0,.08);margin:16px 0"><div class="row"><label for="campTitle">Campaign title</label><input id="campTitle" class="in" type="text" placeholder="e.g. Help with rent"/></div><div class="row"><label for="campAbout">About (why you need donations)</label><textarea id="campAbout" class="in ta" placeholder="Write your story…"></textarea></div><div class="row"><label for="stripeUrl">Your Stripe Payment Link URL</label><input id="stripeUrl" class="in" type="url" placeholder="https://buy.stripe.com/..."/></div><div class="grid2" style="margin-top:10px"><button id="saveBtn" class="btn btnPrimary" type="button">Save campaign</button><button id="copyBtn" class="btn btnGhost" type="button">Copy public link</button></div><div id="pubLinkBox" class="skeleton" style="margin-top:12px;word-break:break-all"></div><div class="tiny" style="margin-top:10px">How to get your Stripe link: open Stripe Dashboard → Payment Links → New, set amount/description, create, then copy the Payment Link URL and paste it above.</div></div><div class="footerMini"><span id="whoami"></span><span id="buildTag"></span></div></div></div><script>(function(){if(window.__donateBooted)return;window.__donateBooted=1;var sb=document.getElementById("statusBox");function setMsg(t,type){if(!sb)return;sb.textContent=t||"";sb.style.display=t?"block":"none";sb.dataset.type=type||"info"}window.addEventListener("error",function(e){setMsg("JS ERROR:\n"+(e.message||e.error||e),"err")});window.addEventListener("unhandledrejection",function(e){var r=e&&e.reason;setMsg("PROMISE ERROR:\n"+((r&&r.message)?r.message:String(r)),"err")});})();</script><script type="module">(async()=>{import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";import{getAuth,onAuthStateChanged,signInWithEmailAndPassword,createUserWithEmailAndPassword,sendPasswordResetEmail,signOut,setPersistence,browserLocalPersistence,sendEmailVerification}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";import{getFirestore,doc,getDoc,setDoc,serverTimestamp}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";const firebaseConfig={apiKey:"AIzaSyBMZo5HOStyDEINl2xLm-M9X4PaDc-raBQ",authDomain:"donate-app-ff07c.firebaseapp.com",projectId:"donate-app-ff07c",storageBucket:"donate-app-ff07c.firebasestorage.app",messagingSenderId:"950201336557",appId:"1:950201336557:web:e8bdfa02d99512051f82e4"};const CREATE_CHECKOUT_URL="https://createcheckout-ywfufoyxmq-nw.a.run.app";const el=(id)=>document.getElementById(id);const qs=new URLSearchParams(location.search);const campaignId=qs.get("c");const publicWrap=el("publicWrap"),privateWrap=el("privateWrap"),pubTitle=el("pubTitle"),pubSub=el("pubSub"),pubMsg=el("pubMsg"),donateLink=el("donateLink"),backHome=el("backHome");const statusBox=el("statusBox"),bootCover=el("bootCover"),authWrap=el("authWrap"),payWrap=el("payWrap"),appWrap=el("appWrap");const emailEl=el("email"),passEl=el("password"),loginBtn=el("loginBtn"),createBtn=el("createBtn"),forgotBtn=el("forgotBtn"),payBtn=el("payBtn"),logoutBtn=el("logoutBtn"),switchUserBtn=el("switchUserBtn");const whoami=el("whoami"),buildTag=el("buildTag");const campTitle=el("campTitle"),campAbout=el("campAbout"),stripeUrl=el("stripeUrl"),saveBtn=el("saveBtn"),copyBtn=el("copyBtn"),pubLinkBox=el("pubLinkBox");const show=(n,y)=>{if(n)n.classList.toggle("hide",!y)};const disable=(btn,y)=>{if(btn){btn.disabled=!!y;btn.style.opacity=y?".7":"1";btn.style.cursor=y?"not-allowed":"pointer"}};const setMsg=(t,type="info")=>{if(!statusBox)return;statusBox.textContent=t||"";statusBox.style.display=t?"block":"none";statusBox.dataset.type=type;};const safeEmail=()=>String(emailEl?.value||"").trim();const safePass=()=>String(passEl?.value||"");buildTag.textContent="build: "+new Date().toISOString().slice(0,16).replace("T"," ");function setWho(u){whoami.textContent=u?.email?u.email:"";}function baseUrl(){let p=location.origin+location.pathname;if(p.endsWith("index.html"))p=p.slice(0,-"index.html".length);if(!p.endsWith("/"))p+="/";return p}const app=initializeApp(firebaseConfig);const auth=getAuth(app);const db=getFirestore(app);try{setPersistence(auth,browserLocalPersistence)}catch(_){ }function uiBoot(){setMsg("","info");show(bootCover,true);show(authWrap,false);show(payWrap,false);show(appWrap,false);show(logoutBtn,false);show(switchUserBtn,false);setWho(null)}function uiLoggedOut(msg){show(bootCover,false);show(authWrap,true);show(payWrap,false);show(appWrap,false);show(logoutBtn,false);show(switchUserBtn,false);setMsg(msg||"Not logged in.","ok");setWho(null)}function uiChecking(u){show(bootCover,false);show(authWrap,false);show(payWrap,false);show(appWrap,false);show(logoutBtn,true);show(switchUserBtn,true);setMsg("Signed in. Checking access…","info");setWho(u)}function uiNeedPay(u){show(bootCover,false);show(authWrap,false);show(payWrap,true);show(appWrap,false);show(logoutBtn,true);show(switchUserBtn,true);setMsg("You’re logged in. Payment required to unlock.","warn");setWho(u)}function uiGranted(u){show(bootCover,false);show(authWrap,false);show(payWrap,false);show(appWrap,true);show(logoutBtn,true);show(switchUserBtn,true);setMsg("Access granted ✅","ok");setWho(u)}function uiError(u,msg){show(bootCover,false);show(authWrap,true);show(payWrap,false);show(appWrap,false);show(logoutBtn,!!u);show(switchUserBtn,!!u);setMsg(msg,"err");setWho(u||null)}async function loadPublic(uid){show(privateWrap,false);show(publicWrap,true);pubMsg.style.display="block";pubMsg.dataset.type="info";pubMsg.textContent="Loading…";donateLink.href="#";donateLink.onclick=(e)=>{e.preventDefault()};try{const snap=await getDoc(doc(db,"campaigns",uid));if(!snap.exists()){pubTitle.textContent="Campaign not found";pubSub.textContent="";pubMsg.dataset.type="warn";pubMsg.textContent="This campaign doesn’t exist yet.";donateLink.classList.add("hide");return;}const data=snap.data()||{};pubTitle.textContent=data.title||"Campaign";pubSub.textContent=data.about||"";const url=String(data.stripeUrl||"").trim();if(!url){pubMsg.dataset.type="warn";pubMsg.textContent="This campaign has no Stripe link yet.";donateLink.classList.add("hide");return;}pubMsg.dataset.type="ok";pubMsg.textContent="Support this campaign via Stripe.";donateLink.classList.remove("hide");donateLink.href=url;donateLink.onclick=null;}catch(e){pubTitle.textContent="Error";pubSub.textContent="";pubMsg.dataset.type="err";pubMsg.textContent="Could not load campaign.\n"+String(e?.message||e);donateLink.classList.add("hide");}}if(campaignId){backHome.href=baseUrl();await loadPublic(campaignId);return;}show(privateWrap,true);show(publicWrap,false);uiBoot();loginBtn?.addEventListener("click",async()=>{try{disable(loginBtn,true);disable(createBtn,true);disable(forgotBtn,true);setMsg("Signing in…","info");const cred=await signInWithEmailAndPassword(auth,safeEmail(),safePass());const u=cred.user;if(u&&!u.emailVerified){try{await sendEmailVerification(u)}catch(_){ }await signOut(auth);uiLoggedOut("Please verify your email first.\nWe’ve sent a verification link.\nAfter you verify, come back and Login.");return;}}catch(err){const code=String(err?.code||"");let msg=err?.message||"Login failed.";if(code==="auth/invalid-credential"||code==="auth/wrong-password"||code==="auth/user-not-found")msg="Login failed.\nEither the account doesn’t exist yet, or the password is wrong.\nTap “Create account” or “Forgot password”.";uiError(null,msg);}finally{disable(loginBtn,false);disable(createBtn,false);disable(forgotBtn,false);}});createBtn?.addEventListener("click",async()=>{try{disable(loginBtn,true);disable(createBtn,true);disable(forgotBtn,true);setMsg("Creating account…","info");const cred=await createUserWithEmailAndPassword(auth,safeEmail(),safePass());try{await sendEmailVerification(cred.user)}catch(_){ }await signOut(auth);uiLoggedOut("Account created ✅\nNow check your email and tap the verification link.\nThen come back and Login.");}catch(err){const code=String(err?.code||"");let msg=err?.message||"Create account failed.";if(code==="auth/email-already-in-use")msg="That email already has an account.\nTap Login, or use Forgot password.";uiError(null,msg);}finally{disable(loginBtn,false);disable(createBtn,false);disable(forgotBtn,false);}});forgotBtn?.addEventListener("click",async()=>{try{const em=safeEmail();if(!em){setMsg("Enter your email first.","warn");return;}disable(loginBtn,true);disable(createBtn,true);disable(forgotBtn,true);setMsg("Sending reset email…","info");await sendPasswordResetEmail(auth,em);setMsg("Password reset email sent ✅\nCheck your inbox then come back and Login.","ok");}catch(err){uiError(auth.currentUser||null,err?.message||"Reset failed.");}finally{disable(loginBtn,false);disable(createBtn,false);disable(forgotBtn,false);}});logoutBtn?.addEventListener("click",async()=>{try{await signOut(auth)}catch(_){ }uiLoggedOut("Not logged in.");});switchUserBtn?.addEventListener("click",async()=>{try{await signOut(auth)}catch(_){ }if(emailEl)emailEl.value="";if(passEl)passEl.value="";uiLoggedOut("Ready for a different account.");});payBtn?.addEventListener("click",async()=>{try{const u=auth.currentUser;if(!u){setMsg("Please login first.","warn");return;}if(!u.emailVerified){setMsg("Verify your email before paying.","warn");return;}disable(payBtn,true);setMsg("Opening checkout…","info");const idToken=await u.getIdToken(true);const base=baseUrl();const successUrl=base+"?success=1";const cancelUrl=base;const res=await fetch(CREATE_CHECKOUT_URL,{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+idToken},body:JSON.stringify({idToken,successUrl,cancelUrl})});if([301,302,303,307,308].includes(res.status)){const loc=res.headers.get("Location");if(loc){location.href=loc;return;}}const ct=(res.headers.get("content-type")||"").toLowerCase();const raw=await res.text().catch(()=> "");if(!res.ok)throw new Error("Checkout error ("+res.status+"):\n"+(raw||"(no response body)"));if(!ct.includes("application/json"))throw new Error("Checkout did not return JSON.\nGot:\n"+raw);let data=null;try{data=JSON.parse(raw||"{}")}catch(_){throw new Error("Checkout returned invalid JSON:\n"+raw)}const url=data?.url||data?.checkoutUrl||data?.checkout_url||data?.sessionUrl||data?.redirectUrl||null;if(!url)throw new Error("No checkout URL returned.\nResponse was:\n"+JSON.stringify(data,null,2));location.href=url}catch(err){uiError(auth.currentUser||null,err?.message||"Failed to start checkout.")}finally{disable(payBtn,false)}});function publicLinkFor(uid){return baseUrl()+"?c="+encodeURIComponent(uid)}function setEditorLink(uid){pubLinkBox.textContent=publicLinkFor(uid)}copyBtn?.addEventListener("click",async()=>{try{const u=auth.currentUser;if(!u){setMsg("Login first.","warn");return;}const link=publicLinkFor(u.uid);await navigator.clipboard.writeText(link);setMsg("Public link copied ✅","ok")}catch(_){setMsg("Could not copy automatically. Tap and hold the link to copy.","warn")}});saveBtn?.addEventListener("click",async()=>{try{const u=auth.currentUser;if(!u){setMsg("Login first.","warn");return;}disable(saveBtn,true);setMsg("Saving…","info");const data={title:String(campTitle?.value||"").trim(),about:String(campAbout?.value||"").trim(),stripeUrl:String(stripeUrl?.value||"").trim(),ownerUid:u.uid,updatedAt:serverTimestamp()};await setDoc(doc(db,"campaigns",u.uid),data,{merge:true});await setDoc(doc(db,"users",u.uid,"campaign","main"),data,{merge:true});setMsg("Saved ✅","ok")}catch(e){setMsg("Save failed:\n"+String(e?.message||e),"err")}finally{disable(saveBtn,false)}});async function loadEditor(uid){setEditorLink(uid);try{const snap=await getDoc(doc(db,"campaigns",uid));if(snap.exists()){const d=snap.data()||{};campTitle.value=d.title||"";campAbout.value=d.about||"";stripeUrl.value=d.stripeUrl||"";}}catch(_){ }}let checking=false;onAuthStateChanged(auth,async(user)=>{if(checking)return;checking=true;try{if(!user){uiLoggedOut("Not logged in.");return;}if(user&&!user.emailVerified){try{await sendEmailVerification(user)}catch(_){ }await signOut(auth);uiLoggedOut("Please verify your email first.\nWe’ve sent a verification link.\nAfter you verify, come back and Login.");return;}uiChecking(user);const snap=await getDoc(doc(db,"users",user.uid,"access","status"));const paid=!!(snap.exists()&&snap.data()?.paid===true);if(paid){uiGranted(user);await loadEditor(user.uid);}else uiNeedPay(user);if(qs.has("success"))setMsg("Payment received ✅\nIf it still says unpaid, tap Logout then Login again.","ok");}catch(err){uiError(user,"Access check failed:\n"+String(err?.message||err))}finally{checking=false}});})();</script></body></html>
