<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sign in</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:sans-serif;background:#f5f5f5;margin:0;padding:20px}
.card{max-width:420px;margin:auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
input,button{width:100%;padding:12px;margin-top:10px;font-size:16px}
button{border:0;border-radius:8px;cursor:pointer}
.primary{background:#000;color:#fff}
.secondary{background:#eee}
.pay{background:#16c784;color:#fff}
.alert{padding:10px;border-radius:8px;margin-bottom:10px}
.alert.red{background:#ffe6e6;color:#900}
.alert.green{background:#e6ffe6;color:#060}
</style>
</head>
<body>

<div class="card">
<h2>Sign in</h2>
<div id="msg"></div>

<input id="email" type="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">

<button class="primary" id="loginBtn">Login</button>
<button class="secondary" id="registerBtn">Create account</button>
<button class="secondary" id="resetBtn">Forgot password</button>

<hr>

<p><b>Payment required.</b><br>Pay once to unlock the app.</p>
<button class="pay" id="payBtn">Pay ¬£5</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyBMZo5HOStyDEINl2xLm-M9X4PaDc-raBQ",
  authDomain:"donate-app-ff07c.firebaseapp.com",
  projectId:"donate-app-ff07c"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

const msg=(t,c="red")=>document.getElementById("msg").innerHTML=`<div class="alert ${c}">${t}</div>`;

loginBtn.onclick=async()=>{
  try{
    await signInWithEmailAndPassword(auth,email.value,password.value);
  }catch(e){msg(e.message)}
};

registerBtn.onclick=async()=>{
  try{
    await createUserWithEmailAndPassword(auth,email.value,password.value);
    msg("Account created. Please login.","green");
  }catch(e){msg(e.message)}
};

resetBtn.onclick=async()=>{
  try{
    await sendPasswordResetEmail(auth,email.value);
    msg("Password reset sent.","green");
  }catch(e){msg(e.message)}
};

payBtn.onclick=async()=>{
  const user=auth.currentUser;
  if(!user){msg("Please login first.");return;}
  const token=await user.getIdToken();
  const r=await fetch("https://europe-west2-donate-app-ff07c.cloudfunctions.net/createCheckout",{
    method:"POST",
    headers:{Authorization:`Bearer ${token}`}
  });
  const d=await r.json();
  location.href=d.url;
};

onAuthStateChanged(auth,async(user)=>{
  if(!user)return;

  // üîÅ re-check Firestore (normal login OR after Stripe redirect)
  const snap=await getDoc(doc(db,"users",user.uid));

  if(snap.exists()&&snap.data().paid===true){
    location.href="app.html";
    return;
  }

  msg("You're logged in, but you haven't paid yet.");
});
</script>
</body>
</html>
