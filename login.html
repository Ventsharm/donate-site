<!doctype html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/><title>Sign in</title><style>html,body{height:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f3f6ff;display:flex;align-items:center;justify-content:center;padding:24px}*{box-sizing:border-box}.card{width:min(520px,100%);background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:22px;box-shadow:0 16px 50px rgba(0,0,0,.08);padding:22px}.h1{font-size:54px;line-height:1;margin:0 0 10px;font-weight:900;letter-spacing:-1px;color:#0b1320}.sub{margin:0 0 14px;color:#3d4a63}.msg{display:none;margin:12px 0 16px;padding:12px 14px;border-radius:14px;border:1px solid rgba(0,0,0,.08);background:#f6f8ff;color:#1e2a44;font-weight:700}.msg[data-type="ok"]{background:#eafff1;color:#0f6b2f}.msg[data-type="warn"]{background:#ffecec;color:#a01414}.msg[data-type="err"]{background:#ffecec;color:#a01414}.row{display:grid;gap:10px;margin:12px 0}label{font-weight:800;color:#1e2a44}.in{width:100%;padding:14px 14px;border-radius:14px;border:1px solid rgba(0,0,0,.14);background:#f1f6ff;font-size:16px;outline:none}.btn{width:100%;padding:15px 16px;border-radius:16px;border:0;font-size:18px;font-weight:900;cursor:pointer}.btnPrimary{background:#0b0b0d;color:#fff;box-shadow:0 10px 25px rgba(0,0,0,.18)}.btnGhost{background:#eef1f6;color:#0b1320}.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}.payCard{margin-top:16px;border-radius:18px;border:1px solid rgba(0,0,0,.10);padding:16px;background:#fff}.payTitle{font-size:22px;margin:0 0 6px;font-weight:900}.payText{margin:0 0 12px;color:#52607a}.payBtn{background:#19c37d;color:#062a19;box-shadow:0 12px 30px rgba(25,195,125,.25)}.tiny{margin-top:10px;color:#5d6b86;font-size:13px;line-height:1.35}.topRow{display:flex;align-items:center;justify-content:space-between;gap:12px}.logout{display:none;background:transparent;border:0;color:#1b4dd8;font-weight:900;font-size:18px;cursor:pointer;padding:8px 0}.emailLine{display:none;margin-top:10px;color:#52607a;font-size:14px;display:flex;justify-content:space-between;gap:12px;align-items:center}.emailLine a{color:#1b4dd8;font-weight:900;text-decoration:underline}.boot{position:fixed;inset:0;background:#f3f6ff;display:flex;align-items:center;justify-content:center;z-index:9999}.bootCard{width:min(520px,100%);margin:24px;background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:22px;box-shadow:0 16px 50px rgba(0,0,0,.08);padding:22px}.bootTitle{font-size:44px;letter-spacing:-1px;margin:0 0 8px;font-weight:900;color:#0b1320}.bootText{margin:0;color:#52607a;font-weight:700}</style></head><body><div id="boot" class="boot"><div class="bootCard"><div class="bootTitle">Sign in</div><div class="bootText">Loading…</div></div></div><div class="card" style="visibility:hidden" id="mainCard"><div class="topRow"><div><h1 class="h1">Sign in</h1><p class="sub">Login first, then pay once to unlock the app.</p></div><button id="logoutBtn" class="logout">Logout</button></div><div id="statusBox" class="msg"></div><div id="authWrap"><div class="row"><label for="email">Email</label><input id="email" class="in" type="email" autocomplete="email" placeholder="you@email.com"/></div><div class="row"><label for="password">Password</label><input id="password" class="in" type="password" autocomplete="current-password" placeholder="••••••••"/></div><button id="loginBtn" class="btn btnPrimary">Login</button><div style="height:12px"></div><div class="grid2"><button id="createBtn" class="btn btnGhost">Create account</button><button id="forgotBtn" class="btn btnGhost">Forgot password</button></div><div class="emailLine" id="emailLine"><span id="who"></span><a href="#" id="logoutLink">Logout</a></div></div><div id="payWrap" class="payCard"><div class="payTitle">Payment required.</div><p class="payText">Pay once to unlock the app.</p><button id="payBtn" class="btn payBtn">Pay £5</button><div class="tiny">After payment you’ll be redirected back. If you see “Payment received”, tap “Back to login”.</div></div><div id="appWrap" style="display:none;margin-top:16px"><h2 style="margin:0 0 10px;font-size:44px;letter-spacing:-1px">Your account</h2><div style="padding:12px 14px;border-radius:14px;border:1px solid rgba(0,0,0,.08);background:#eafff1;color:#0f6b2f;font-weight:900">Access granted ✅</div><p style="margin:12px 0 0;color:#52607a">Redirecting to the app…</p></div></div><script type="module">import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";import{getAuth,onAuthStateChanged,signInWithEmailAndPassword,createUserWithEmailAndPassword,sendPasswordResetEmail,signOut,setPersistence,browserLocalPersistence}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";import{getFirestore,doc,getDoc}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";const firebaseConfig={apiKey:"AIzaSyBMZo5HOStyDEINl2xLm-M9X4PaDc-raBQ",authDomain:"donate-app-ff07c.firebaseapp.com",projectId:"donate-app-ff07c",storageBucket:"donate-app-ff07c.firebasestorage.app",messagingSenderId:"950201336557",appId:"1:950201336557:web:e8bdfa02d99512051f82e4"};const app=initializeApp(firebaseConfig),auth=getAuth(app),db=getFirestore(app);await setPersistence(auth,browserLocalPersistence).catch(()=>{});const CREATE_CHECKOUT_URLS=["https://europe-west2-donate-app-ff07c.cloudfunctions.net/createCheckout"];const ACCESS_DOC=uid=>doc(db,"users",uid,"access","status");const APP_URL="app.html";const el=id=>document.getElementById(id),emailEl=el("email"),passEl=el("password"),loginBtn=el("loginBtn"),createBtn=el("createBtn"),forgotBtn=el("forgotBtn"),payBtn=el("payBtn"),logoutBtn=el("logoutBtn"),logoutLink=el("logoutLink"),statusBox=el("statusBox"),appWrap=el("appWrap"),authWrap=el("authWrap"),payWrap=el("payWrap"),boot=el("boot"),mainCard=el("mainCard"),emailLine=el("emailLine"),who=el("who");const qs=new URLSearchParams(location.search);const show=(n,y)=>{if(n)n.style.display=y?"block":"none"};const setMsg=(t,type="info")=>{statusBox.textContent=t||"";statusBox.style.display=t?"block":"none";statusBox.dataset.type=type};const safeEmail=()=>String(emailEl?.value||"").trim(),safePass=()=>String(passEl?.value||"");const setUiReady=()=>{boot.style.display="none";mainCard.style.visibility="visible"};const setLoggedOutUI=(msg="Not logged in.")=>{show(authWrap,true);show(payWrap,true);show(appWrap,false);logoutBtn.style.display="none";show(emailLine,false);setMsg(msg,"ok")};const setCheckingUI=(msg="Checking access…")=>{show(authWrap,true);show(payWrap,true);show(appWrap,false);logoutBtn.style.display="inline-block";show(emailLine,true);setMsg(msg,"info")};const setPayUI=(userEmail="")=>{show(authWrap,true);show(payWrap,true);show(appWrap,false);logoutBtn.style.display="inline-block";show(emailLine,true);setMsg(`You're logged in (${userEmail||"user"}), but you haven't paid yet.`,"warn")};const setAppUI=()=>{show(authWrap,false);show(payWrap,false);show(appWrap,true);logoutBtn.style.display="inline-block";show(emailLine,true);setMsg("Access granted ✅","ok");setTimeout(()=>{if(APP_URL)location.href=APP_URL},600)};const doLogout=async()=>{try{await signOut(auth)}catch(_){}setLoggedOutUI("Not logged in.")};logoutBtn?.addEventListener("click",e=>{e.preventDefault();doLogout()});logoutLink?.addEventListener("click",e=>{e.preventDefault();doLogout()});loginBtn?.addEventListener("click",async e=>{e.preventDefault();try{setMsg("Signing in…","info");await signInWithEmailAndPassword(auth,safeEmail(),safePass())}catch(err){setMsg(err?.message||"Login failed.","err")}});createBtn?.addEventListener("click",async e=>{e.preventDefault();try{setMsg("Creating account…","info");await createUserWithEmailAndPassword(auth,safeEmail(),safePass())}catch(err){setMsg(err?.message||"Create account failed.","err")}});forgotBtn?.addEventListener("click",async e=>{e.preventDefault();try{const em=safeEmail();if(!em){setMsg("Enter your email first.","warn");return}setMsg("Sending reset email…","info");await sendPasswordResetEmail(auth,em);setMsg("Password reset email sent.","ok")}catch(err){setMsg(err?.message||"Reset failed.","err")}});async function postCheckout(url,idToken){const res=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idToken})});if(!res.ok){const t=await res.text().catch(()=> "");throw new Error(`Checkout error (${res.status}). ${t||""}`)}const data=await res.json().catch(()=>null);if(!data?.url)throw new Error("No checkout URL returned.");return data.url}payBtn?.addEventListener("click",async e=>{e.preventDefault();try{const u=auth.currentUser;if(!u){setMsg("Please log in first, then pay.","warn");return}setMsg("Opening checkout…","info");const idToken=await u.getIdToken(true);let lastErr=null;for(const url of CREATE_CHECKOUT_URLS){try{const checkoutUrl=await postCheckout(url,idToken);location.href=checkoutUrl;return}catch(err){lastErr=err}}throw lastErr||new Error("Could not start checkout.");}catch(err){setMsg(err?.message||"Failed to start checkout.","err")}});let firstAuthResolved=false;onAuthStateChanged(auth,async user=>{try{if(!firstAuthResolved){firstAuthResolved=true;setUiReady()}if(!user){setLoggedOutUI("Not logged in.");return}who.textContent=user.email||"Logged in";setCheckingUI("Signed in. Checking access…");const snap=await getDoc(ACCESS_DOC(user.uid));const paid=!!(snap.exists()&&snap.data()?.paid===true);if(paid){setAppUI()}else{setPayUI(user.email||"")}}catch(err){const m=String(err?.message||"");if(m.includes("Missing or insufficient permissions"))setMsg("Missing or insufficient permissions. Check Firestore rules + path users/{uid}/access/status","err");else setMsg("Access check failed: "+m,"err");show(authWrap,true);show(payWrap,true);show(appWrap,false);logoutBtn.style.display="inline-block";show(emailLine,!!auth.currentUser)}});if(qs.has("session_id")||qs.has("success"))setMsg("Payment received. If access doesn’t update within a few seconds, go back and refresh.","ok");</script></body></html>
