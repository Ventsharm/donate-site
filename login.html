<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Login</title><style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#fff;padding:18px}#card{max-width:420px;margin:18px auto;border:1px solid #eee;border-radius:20px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.06)}h1{font-size:52px;margin:8px 0 14px}label{display:block;margin:12px 0 6px;font-weight:700}input{width:100%;box-sizing:border-box;padding:14px 12px;border:1px solid #d9d9d9;border-radius:12px;font-size:16px;background:#f3f6ff}button{width:100%;padding:16px 14px;border:0;border-radius:16px;font-size:18px;font-weight:800;margin-top:12px}#loginBtn{background:#111;color:#fff}#createBtn,#resetBtn{background:#eee;color:#111}#payBtn{background:#19b57a;color:#fff}#msg{padding:12px 12px;border-radius:12px;margin:10px 0 14px;border:1px solid transparent}#msg.ok{background:#eaffef;border-color:#bfe9c9;color:#0f6b2f}#msg.bad{background:#ffecec;border-color:#ffc7c7;color:#9b1c1c}#msg.neutral{background:#eef6ff;border-color:#cfe3ff;color:#134a8b}.small{font-size:13px;opacity:.8;margin-top:10px}</style></head><body><div id="card"><h1>Sign in</h1><div id="msg" class="neutral">Loading…</div><label>Email</label><input id="email" type="email" autocomplete="email" placeholder="you@email.com"><label>Password</label><input id="pass" type="password" autocomplete="current-password" placeholder="••••••••"><button id="loginBtn">Login</button><button id="createBtn">Create account</button><button id="resetBtn">Forgot password</button><div style="margin-top:16px;padding:14px;border:1px solid #eee;border-radius:16px"><div style="font-weight:900;margin-bottom:6px">Payment required</div><div style="opacity:.85;margin-bottom:10px">Pay once to unlock the app.</div><button id="payBtn">Pay £5</button><div class="small" id="note"></div></div></div><script type="module">
/* --- HARD KILL ANY OLD PWA/SW CACHE (stops flashing) --- */
(async()=>{try{if("serviceWorker"in navigator){const regs=await navigator.serviceWorker.getRegistrations();for(const r of regs)await r.unregister();}if("caches"in window){const keys=await caches.keys();for(const k of keys)await caches.delete(k);}}catch(e){}})();

import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import{getAuth,setPersistence,browserLocalPersistence,onAuthStateChanged,signInWithEmailAndPassword,createUserWithEmailAndPassword,sendPasswordResetEmail}from"https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import{getFirestore,doc,getDoc}from"https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyBMZo5HOStyDEINl2xLm-M9X4PaDc-raBQ",authDomain:"donate-app-ff07c.firebaseapp.com",projectId:"donate-app-ff07c",storageBucket:"donate-app-ff07c.firebasestorage.app",messagingSenderId:"950201336557",appId:"1:950201336557:web:e8bdfa02d99512051f82e4"};
const CREATE_CHECKOUT_URL="https://createcheckout-ywfufoyxmq-nw.a.run.app";

const app=initializeApp(firebaseConfig),auth=getAuth(app),db=getFirestore(app);
await setPersistence(auth,browserLocalPersistence);

const $=id=>document.getElementById(id);
const msgEl=$("msg"),note=$("note");
const show=(t,cls)=>{msgEl.className=cls;msgEl.textContent=t;};
const sleep=t=>new Promise(r=>setTimeout(r,t));

let busy=false,lastShown="";

async function isPaid(uid){
  const snap=await getDoc(doc(db,"users",uid,"access","access"));
  return !!(snap.exists() && snap.data()?.paid===true);
}

/* Guard to stop UI flipping repeatedly */
onAuthStateChanged(auth,async u=>{
  if(busy) return;
  busy=true;
  try{
    if(!u){if(lastShown!=="out"){show("Not logged in.","ok");lastShown="out";}return;}
    if(lastShown!=="check"){show("Logged in. Checking payment…","neutral");lastShown="check";}
    const paid=await isPaid(u.uid);
    if(paid){show("Paid ✅ Redirecting…","ok");lastShown="in";location.replace("app.html");return;}
    show("Logged in, but not paid yet.","bad");lastShown="needpay";
  }catch(e){
    show("Error checking payment.","bad");note.textContent=String(e?.message||e);
  }finally{
    busy=false;
  }
});

$("loginBtn").onclick=async()=>{try{show("Signing in…","neutral");await signInWithEmailAndPassword(auth,$("email").value.trim(),$("pass").value);}catch(e){show(e.message||"Login failed","bad");}};
$("createBtn").onclick=async()=>{try{show("Creating account…","neutral");await createUserWithEmailAndPassword(auth,$("email").value.trim(),$("pass").value);}catch(e){show(e.message||"Create failed","bad");}};
$("resetBtn").onclick=async()=>{try{show("Sending reset…","neutral");await sendPasswordResetEmail(auth,$("email").value.trim());show("Reset email sent.","ok");}catch(e){show(e.message||"Reset failed","bad");}};

$("payBtn").onclick=async()=>{
  const u=auth.currentUser;
  if(!u){show("Login first, then pay.","bad");return;}
  try{
    show("Opening Stripe checkout…","neutral");
    const token=await u.getIdToken(true);
    const res=await fetch(CREATE_CHECKOUT_URL,{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+token},body:JSON.stringify({successUrl:"https://ventsharm.github.io/donate-site/success.html",cancelUrl:"https://ventsharm.github.io/donate-site/login.html?canceled=1"})});
    if(!res.ok){const t=await res.text().catch(()=> "");throw new Error("createCheckout failed: "+res.status+" "+t);}
    const data=await res.json();
    if(!data.url) throw new Error("No checkout url returned");
    location.href=data.url;
  }catch(e){
    show("Checkout failed.","bad");note.textContent=String(e?.message||e);
  }
};
</script></body></html>
