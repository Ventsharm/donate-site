<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Donate App – Login</title>

<style>
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f3f6ff;display:flex;align-items:center;justify-content:center;padding:24px}
*{box-sizing:border-box}
.card{width:min(560px,100%);background:#fff;border-radius:24px;box-shadow:0 16px 55px rgba(0,0,0,.12);padding:24px}
h1{font-size:52px;margin:0;font-weight:900}
.sub{margin:8px 0 16px;color:#3d4a63;font-weight:600}
.msg{display:none;margin:12px 0;padding:12px 14px;border-radius:14px;font-weight:800}
.msg.ok{background:#eafff1;color:#0f6b2f}
.msg.warn{background:#ffecec;color:#a01414}
.msg.err{background:#ffecec;color:#a01414}
.row{margin:12px 0}
label{font-weight:900}
input{width:100%;padding:14px;border-radius:14px;border:1px solid #ccd;font-size:16px;background:#f1f6ff}
button{width:100%;padding:15px;border-radius:16px;border:0;font-size:18px;font-weight:900;cursor:pointer}
.primary{background:#0b0b0d;color:#fff}
.ghost{background:#eef1f6}
.pay{background:#19c37d;color:#062a19}
.hidden{display:none}
.small{font-size:13px;color:#5d6b86;margin-top:10px}
footer{margin-top:12px;font-size:13px;color:#5d6b86}
</style>
</head>

<body>
<div class="card">

<h1>Sign in</h1>
<p class="sub">Login first, then pay once to unlock the app.</p>

<div id="msg" class="msg"></div>

<div id="loginBox">
  <div class="row">
    <label>Email</label>
    <input id="email" type="email">
  </div>
  <div class="row">
    <label>Password</label>
    <input id="password" type="password">
  </div>
  <button id="loginBtn" class="primary">Login</button>
  <div class="row">
    <button id="createBtn" class="ghost">Create account</button>
  </div>
  <div class="row">
    <button id="resetBtn" class="ghost">Forgot password</button>
  </div>
</div>

<div id="payBox" class="hidden">
  <p><strong>Payment required.</strong></p>
  <button id="payBtn" class="pay">Pay £5</button>
  <p class="small">After payment, return here.</p>
</div>

<div id="appBox" class="hidden">
  <div class="msg ok">Access granted ✅</div>
  <p>Your app goes here.</p>
  <button id="logoutBtn" class="ghost">Logout</button>
</div>

<footer id="who"></footer>

</div>

<script type="module">
(async()=>{

/* ---- Firebase SDKs ---- */
const [{initializeApp},{getAuth,onAuthStateChanged,signInWithEmailAndPassword,createUserWithEmailAndPassword,sendPasswordResetEmail,signOut},{getFirestore,doc,getDoc}] =
await Promise.all([
  import("https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js"),
  import("https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js"),
  import("https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js")
]);

/* ---- CONFIG (YOURS) ---- */
const firebaseConfig={
  apiKey:"AIzaSyBMZo5HOStyDEINl2xLm-M9X4PaDc-raBQ",
  authDomain:"donate-app-ff07c.firebaseapp.com",
  projectId:"donate-app-ff07c",
  storageBucket:"donate-app-ff07c.firebasestorage.app",
  messagingSenderId:"950201336557",
  appId:"1:950201336557:web:e8bdfa02d99512051f82e4"
};

const CHECKOUT_URL="https://createcheckout-ywfufoyxmq-nw.a.run.app";

/* ---- Init ---- */
const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

/* ---- UI ---- */
const msg=t=>{box.textContent=t.text;box.className="msg "+t.type;box.style.display="block"};
const hide=el=>el.classList.add("hidden");
const show=el=>el.classList.remove("hidden");

const email=e=>document.getElementById("email").value;
const pass=e=>document.getElementById("password").value;

const box=document.getElementById("msg");
const loginBox=document.getElementById("loginBox");
const payBox=document.getElementById("payBox");
const appBox=document.getElementById("appBox");
const who=document.getElementById("who");

/* ---- Buttons ---- */
loginBtn.onclick=()=>signInWithEmailAndPassword(auth,email(),pass()).catch(e=>msg({text:e.message,type:"err"}));
createBtn.onclick=()=>createUserWithEmailAndPassword(auth,email(),pass()).catch(e=>msg({text:e.message,type:"err"}));
resetBtn.onclick=()=>sendPasswordResetEmail(auth,email()).then(()=>msg({text:"Reset email sent",type:"ok"}));
logoutBtn.onclick=()=>signOut(auth);

payBtn.onclick=async()=>{
  const u=auth.currentUser;
  if(!u)return msg({text:"Login first",type:"warn"});
  const token=await u.getIdToken(true);
  const r=await fetch(CHECKOUT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idToken:token})});
  const d=await r.json();
  location.href=d.url;
};

/* ---- Auth state ---- */
onAuthStateChanged(auth,async u=>{
  hide(loginBox);hide(payBox);hide(appBox);box.style.display="none";
  if(!u){show(loginBox);who.textContent="";return;}
  who.textContent=u.email;
  const snap=await getDoc(doc(db,"users",u.uid,"access","status"));
  if(snap.exists() && snap.data().paid===true){
    show(appBox);
  }else{
    show(payBox);
    msg({text:"Logged in but not paid yet",type:"warn"});
  }
});

})();
</script>
</body>
</html>
