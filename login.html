<!doctype html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Sign in</title><style>html,body{height:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f3f6ff;display:flex;align-items:center;justify-content:center;padding:24px}*{box-sizing:border-box}.card{width:min(520px,100%);background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:22px;box-shadow:0 16px 50px rgba(0,0,0,.08);padding:22px}.h1{font-size:54px;line-height:1;margin:0 0 12px;font-weight:900;letter-spacing:-1px;color:#0b1320}.sub{margin:0 0 14px;color:#3d4a63}.msg{display:none;margin:12px 0 16px;padding:12px 14px;border-radius:14px;border:1px solid rgba(0,0,0,.08);background:#f6f8ff;color:#1e2a44;font-weight:600}.msg[data-type="ok"]{background:#eafff1;color:#0f6b2f}.msg[data-type="warn"]{background:#ffecec;color:#a01414}.msg[data-type="err"]{background:#ffecec;color:#a01414}.row{display:grid;gap:10px;margin:12px 0}label{font-weight:800;color:#1e2a44}.in{width:100%;padding:14px 14px;border-radius:14px;border:1px solid rgba(0,0,0,.14);background:#f1f6ff;font-size:16px;outline:none}.btn{width:100%;padding:15px 16px;border-radius:16px;border:0;font-size:18px;font-weight:900;cursor:pointer}.btnPrimary{background:#0b0b0d;color:#fff;box-shadow:0 10px 25px rgba(0,0,0,.18)}.btnGhost{background:#eef1f6;color:#0b1320}.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}.payCard{margin-top:16px;border-radius:18px;border:1px solid rgba(0,0,0,.10);padding:16px;background:#fff}.payTitle{font-size:22px;margin:0 0 6px;font-weight:900}.payText{margin:0 0 12px;color:#52607a}.payBtn{background:#19c37d;color:#062a19;box-shadow:0 12px 30px rgba(25,195,125,.25)}.tiny{margin-top:10px;color:#5d6b86;font-size:13px;line-height:1.35}.topRow{display:flex;align-items:center;justify-content:space-between;gap:12px}.logout{display:none;background:transparent;border:0;color:#1b4dd8;font-weight:900;font-size:18px;cursor:pointer;padding:8px 0}</style></head><body><div class="card"><div class="topRow"><div><h1 class="h1">Sign in</h1><p class="sub">Login first, then pay once to unlock the app.</p></div><button id="logoutBtn" class="logout">Logout</button></div><div id="statusBox" class="msg"></div><div id="authWrap"><div class="row"><label for="email">Email</label><input id="email" class="in" type="email" autocomplete="email" placeholder="you@email.com"/></div><div class="row"><label for="password">Password</label><input id="password" class="in" type="password" autocomplete="current-password" placeholder="••••••••"/></div><button id="loginBtn" class="btn btnPrimary">Login</button><div style="height:12px"></div><div class="grid2"><button id="createBtn" class="btn btnGhost">Create account</button><button id="forgotBtn" class="btn btnGhost">Forgot password</button></div></div><div id="payWrap" class="payCard"><div class="payTitle">Payment required.</div><p class="payText">Pay once to unlock the app.</p><button id="payBtn" class="btn payBtn">Pay £5</button><div class="tiny">After payment you’ll be redirected back. If you see “Payment received”, tap “Back to login”.</div></div><div id="appWrap" style="display:none;margin-top:16px"><h2 style="margin:0 0 10px;font-size:44px;letter-spacing:-1px">Your account</h2><div style="padding:12px 14px;border-radius:14px;border:1px solid rgba(0,0,0,.08);background:#eafff1;color:#0f6b2f;font-weight:900">Access granted ✅</div><p style="margin:12px 0 0;color:#52607a">Put your real app UI here.</p></div></div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import{getAuth,onAuthStateChanged,signInWithEmailAndPassword,createUserWithEmailAndPassword,sendPasswordResetEmail,signOut}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import{getFirestore,doc,getDoc}from"https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
const firebaseConfig={apiKey:"AIzaSyBMZo5HOStyDEInl2xLm-M9X4PaDc-raBQ",authDomain:"donate-app-ff07c.firebaseapp.com",projectId:"donate-app-ff07c",storageBucket:"donate-app-ff07c.firebasestorage.app",messagingSenderId:"950201336557",appId:"1:950201336557:web:e8bdfa02d99512051f82e4"};
const app=initializeApp(firebaseConfig),auth=getAuth(app),db=getFirestore(app);

// ✅ PASTE your createCheckout function URL here:
const CREATE_CHECKOUT_URL="https://createcheckout-ywfufoyxmq-nw.a.run.app";

const ACCESS_DOC=(uid)=>doc(db,"users",uid,"access","status");
const el=(id)=>document.getElementById(id);
const emailEl=el("email"),passEl=el("password"),loginBtn=el("loginBtn"),createBtn=el("createBtn"),forgotBtn=el("forgotBtn"),payBtn=el("payBtn"),logoutBtn=el("logoutBtn"),statusBox=el("statusBox"),appWrap=el("appWrap"),authWrap=el("authWrap"),payWrap=el("payWrap");
const qs=new URLSearchParams(location.search);
const show=(n,y)=>{if(n)n.style.display=y?"block":"none"};
const setMsg=(t,type="info")=>{if(!statusBox)return;statusBox.textContent=t||"";statusBox.style.display=t?"block":"none";statusBox.dataset.type=type;};
const safeEmail=()=>String(emailEl?.value||"").trim(),safePass=()=>String(passEl?.value||"");
let manualLogin=false;
const setManual=()=>{manualLogin=true;sessionStorage.setItem("manualLogin","1");};
manualLogin=sessionStorage.getItem("manualLogin")==="1";
function showLoggedOutUI(msg="Not logged in."){show(authWrap,true);show(payWrap,true);show(appWrap,false);if(logoutBtn)logoutBtn.style.display="none";setMsg(msg,"ok");}
function showCheckingUI(msg="Checking access..."){show(authWrap,true);show(payWrap,true);show(appWrap,false);if(logoutBtn)logoutBtn.style.display="inline-block";setMsg(msg,"info");}
function showPayUI(userEmail){show(authWrap,true);show(payWrap,true);show(appWrap,false);if(logoutBtn)logoutBtn.style.display="inline-block";setMsg(`You're logged in (${userEmail||"user"}), but you haven't paid yet.`,"warn");}
function showAppUI(){show(authWrap,false);show(payWrap,false);show(appWrap,true);if(logoutBtn)logoutBtn.style.display="inline-block";setMsg("Access granted ✅","ok");}
if(loginBtn)loginBtn.addEventListener("click",async(e)=>{e.preventDefault();try{setMsg("Signing in...","info");setManual();await signInWithEmailAndPassword(auth,safeEmail(),safePass());}catch(err){setMsg(err?.message||"Login failed.","err");}});
if(createBtn)createBtn.addEventListener("click",async(e)=>{e.preventDefault();try{setMsg("Creating account...","info");setManual();await createUserWithEmailAndPassword(auth,safeEmail(),safePass());}catch(err){setMsg(err?.message||"Create account failed.","err");}});
if(forgotBtn)forgotBtn.addEventListener("click",async(e)=>{e.preventDefault();try{const em=safeEmail();if(!em){setMsg("Enter your email first.","warn");return;}setMsg("Sending reset email...","info");await sendPasswordResetEmail(auth,em);setMsg("Password reset email sent.","ok");}catch(err){setMsg(err?.message||"Reset failed.","err");}});
if(logoutBtn)logoutBtn.addEventListener("click",async(e)=>{e.preventDefault();try{await signOut(auth);}catch(_){}sessionStorage.removeItem("manualLogin");manualLogin=false;showLoggedOutUI("Not logged in.");});
if(payBtn)payBtn.addEventListener("click",async(e)=>{e.preventDefault();try{const u=auth.currentUser;if(!u){setMsg("Please log in first, then pay.","warn");return;}setManual();setMsg("Opening checkout...","info");const idToken=await u.getIdToken(true);const res=await fetch(CREATE_CHECKOUT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idToken})});if(!res.ok){const t=await res.text().catch(()=> "");throw new Error(`Checkout error (${res.status}). ${t}`);}const data=await res.json();if(!data?.url)throw new Error("No checkout URL returned.");location.href=data.url;}catch(err){setMsg(err?.message||"Failed to start checkout.","err");}});
let checking=false;
onAuthStateChanged(auth,async(user)=>{if(checking)return;checking=true;try{if(!user){showLoggedOutUI("Not logged in.");return;}
if(!manualLogin){showLoggedOutUI("Not logged in.");return;}
showCheckingUI("Signed in. Checking access...");
const snap=await getDoc(ACCESS_DOC(user.uid));
const paid=!!(snap.exists()&&snap.data()?.paid===true);
if(paid){showAppUI();}else{showPayUI(user.email||"");}
}catch(err){const msg=String(err?.message||"Access check failed.");setMsg(msg.includes("Missing or insufficient permissions")?"Missing or insufficient permissions. Check Firestore rules + path users/{uid}/access/status":"Access check failed: "+msg,"err");show(authWrap,true);show(payWrap,true);show(appWrap,false);if(logoutBtn)logoutBtn.style.display="inline-block";}
finally{checking=false;}});
if(qs.has("session_id")||qs.has("success")){setManual();}
</script></body></html>
