<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sign in</title>

<style>
body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;background:#f5f5f5;margin:0;padding:20px}
.card{max-width:420px;margin:0 auto;background:#fff;border-radius:18px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
h1{margin:0 0 16px}
input,button{width:100%;padding:14px;margin:10px 0;border-radius:12px;border:1px solid #ddd;font-size:16px}
button{background:#000;color:#fff;border:none}
.secondary{background:#eee;color:#000}
.pay{background:#16c784;color:#fff}
.msg{padding:12px;border-radius:10px;margin-bottom:12px}
.ok{background:#e6fffa;color:#065f46}
.err{background:#fee2e2;color:#991b1b}
.hide{display:none}
</style>
</head>

<body>
<div class="card">
<h1>Sign in</h1>

<div id="message" class="msg hide"></div>

<input id="email" type="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">

<button id="loginBtn">Login</button>
<button id="signupBtn" class="secondary">Create account</button>
<button id="resetBtn" class="secondary">Forgot password</button>

<hr style="margin:20px 0">

<div id="payBox" class="hide">
<p><strong>Payment required.</strong><br>Pay once to unlock the app.</p>
<button id="payBtn" class="pay">Pay £5</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ===== FIREBASE CONFIG (YOURS) ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBMZo5HOStyDEINl2xLm-M9X4PaDc-raBQ",
  authDomain: "donate-app-ff07c.firebaseapp.com",
  projectId: "donate-app-ff07c",
  storageBucket: "donate-app-ff07c.firebasestorage.app",
  messagingSenderId: "950201336557",
  appId: "1:950201336557:web:e8bdfa02d99512051f82e4"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ===== UI ===== */
const msg = document.getElementById("message");
const payBox = document.getElementById("payBox");

function show(text,type){
  msg.textContent=text;
  msg.className="msg "+type;
}

/* ===== AUTH STATE ===== */
onAuthStateChanged(auth, async user => {
  if(!user){
    show("Not logged in.","ok");
    payBox.classList.add("hide");
    return;
  }

  const snap = await getDoc(doc(db,"users",user.uid));
  if(snap.exists() && snap.data().paid === true){
    show("Access granted. Redirecting…","ok");
    location.href="app.html";
  }else{
    show("You're logged in, but you haven't paid yet.","err");
    payBox.classList.remove("hide");
  }
});

/* ===== ACTIONS ===== */
loginBtn.onclick = async ()=>{
  try{
    await signInWithEmailAndPassword(auth,email.value,password.value);
  }catch(e){
    show(e.message,"err");
  }
};

signupBtn.onclick = async ()=>{
  try{
    await createUserWithEmailAndPassword(auth,email.value,password.value);
    show("Account created. Please pay to unlock.","ok");
  }catch(e){
    show(e.message,"err");
  }
};

resetBtn.onclick = async ()=>{
  try{
    await sendPasswordResetEmail(auth,email.value);
    show("Password reset email sent.","ok");
  }catch(e){
    show(e.message,"err");
  }
};

payBtn.onclick = ()=>{
  location.href="https://europe-west2-donate-app-ff07c.cloudfunctions.net/createCheckout";
};
</script>
</body>
</html>
