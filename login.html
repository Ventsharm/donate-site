<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sign in</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:system-ui;background:#f4f6fb;margin:0;padding:20px}
.card{max-width:420px;margin:40px auto;background:#fff;border-radius:16px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
h1{margin:0 0 16px}
input,button{width:100%;padding:14px;margin-top:10px;border-radius:10px;border:1px solid #ddd;font-size:16px}
button{border:none;background:#000;color:#fff;font-weight:600}
button.secondary{background:#eee;color:#000}
.status{margin-bottom:12px;padding:12px;border-radius:10px;font-size:14px}
.ok{background:#e8f7ee;color:#0a7a3f}
.err{background:#fdeaea;color:#a40000}
.pay{margin-top:20px;padding:16px;border-radius:14px;background:#f7f7f7}
.pay button{background:#14b87a}
.hidden{display:none}
</style>
</head>

<body>
<div class="card">
<h1>Sign in</h1>

<div id="status" class="status ok">Loading…</div>

<input id="email" type="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">

<button id="loginBtn">Login</button>
<button id="signupBtn" class="secondary">Create account</button>
<button id="resetBtn" class="secondary">Forgot password</button>

<div id="payBox" class="pay hidden">
<b>Payment required</b>
<p>Pay once to unlock the app.</p>
<button id="payBtn">Pay £5</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMZo5HOStyDEINl2xLm-M9X4PaDc-raBQ",
  authDomain: "donate-app-ff07c.firebaseapp.com",
  projectId: "donate-app-ff07c",
  storageBucket: "donate-app-ff07c.firebasestorage.app",
  messagingSenderId: "950201336557",
  appId: "1:950201336557:web:e8bdfa02d99512051f82e4"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const status = document.getElementById("status");
const payBox = document.getElementById("payBox");

function show(msg,type="ok"){status.textContent=msg;status.className="status "+type}

document.getElementById("loginBtn").onclick=async()=>{
  show("Signing in…");
  try{
    await signInWithEmailAndPassword(auth,email.value,password.value);
  }catch(e){show(e.message,"err")}
};

document.getElementById("signupBtn").onclick=async()=>{
  show("Creating account…");
  try{
    await createUserWithEmailAndPassword(auth,email.value,password.value);
  }catch(e){show(e.message,"err")}
};

document.getElementById("resetBtn").onclick=async()=>{
  if(!email.value) return show("Enter your email","err");
  await sendPasswordResetEmail(auth,email.value);
  show("Password reset sent");
};

document.getElementById("payBtn").onclick=async()=>{
  const res = await fetch("https://europe-west2-donate-app-ff07c.cloudfunctions.net/createCheckout",{
    method:"POST",
    headers:{Authorization:"Bearer "+await auth.currentUser.getIdToken()}
  });
  const data = await res.json();
  location.href = data.url;
};

onAuthStateChanged(auth, async user=>{
  if(!user){
    show("Not logged in");
    payBox.classList.add("hidden");
    return;
  }

  show("Checking access…");
  const snap = await getDoc(doc(db,"users",user.uid,"access","status"));

  if(snap.exists() && snap.data().paid===true){
    location.href="app.html";
  }else{
    show("You're logged in, but haven't paid yet.","err");
    payBox.classList.remove("hidden");
  }
});
</script>
</body>
</html>
